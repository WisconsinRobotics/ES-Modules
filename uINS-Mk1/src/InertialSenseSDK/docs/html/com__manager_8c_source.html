<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>SDK: src/com_manager.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo_Full_color_300x61.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SDK
   &#160;<span id="projectnumber">Release 1.1.3</span>
   </div>
   <div id="projectbrief">Communications, logger, and bootloader libraries.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">com_manager.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">MIT LICENSE</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">Copyright 2014 Inertial Sense, LLC - http://inertialsense.com</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files(the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions :</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;com_manager.h&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// allow packet continuation or not. If enabled, an extra 1K buffer is allocated globally for each com_manager_t instance.</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#define ENABLE_PACKET_CONTINUATION 1</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">// enable filtering of duplicate packets</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#define ENABLE_FILTER_DUPLICATE_PACKETS 1</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// whether the first character or all characters are checked in duplicate packets</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#define ENABLE_FILTER_DUPLICATE_PACKETS_MATCH_ALL_CHARACTERS 0</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#define PARSE_DOUBLE(str) strtod(str, 0)</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#define PARSE_FLOAT(str) strtof(str, 0)</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#define MIN_REQUEST_PERIOD_MS       1               // (ms) 1 KHz</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#define MAX_REQUEST_PERIOD_MS       100000          // (ms)</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#define MSG_PERIOD_SEND_ONCE        -1</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#define MSG_PERIOD_DISABLED         0</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#define CHECKSUM_SEED 0x00AAAAAA</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/* Contains callback information for a before and after send for a data structure */</span></div><div class="line"><a name="l00037"></a><span class="lineno"><a class="line" href="structregistered__data__t.html">   37</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;{</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="comment">/* Pointer and size of entire data struct (not sub portion that is communicated) */</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <a class="code" href="structbuf_tx_rx_ptr__t.html">bufTxRxPtr_t</a> dataSet;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">/* Callback function pointer, used to prepare data before send */</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    pfnComManagerPreSend preTxFnc;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">/* Callback function pointer, used to prepare data after received */</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    pfnComManagerPostRead pstRxFnc;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    </div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">/* Packet type to use */</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    uint8_t pktFlags;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;} <a class="code" href="structregistered__data__t.html">registered_data_t</a>;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">/* Contains data that determines what messages are being broadcast */</span></div><div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="structbroadcast__msg__t.html">   53</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;{</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">/* Packet  */</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="structpkt__info__t.html">pkt_info_t</a>              pkt;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">/* Broadcast specific data header (i.e. data size and offset) */</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>            dataHdr;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">/* Pointer and size of entire data set (not sub portion that is communicated) */</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <a class="code" href="structbuf_tx_rx_ptr__t.html">bufTxRxPtr_t</a>            dataSet;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">/* Broadcast period counter */</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordtype">int</span>                     counter;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">/* Millisecond broadcast period intervals.  -1 = send once.  0 = disabled/unused/don&#39;t send. */</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordtype">int</span>                     period;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">/* Linked list pointer.  0 indicates this is the head. */</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordtype">void</span>*                   llPrv;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">/* Linked list pointer.  0 indicates this is the tail. */</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordtype">void</span>*                   llNxt;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">/* Port to broadcast on. */</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordtype">int</span>                     pHandle;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;} <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">/* Contains data to implement ensured packet delivery */</span></div><div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="structensured__pkt__t.html">   81</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;{</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">/* Packet struct */</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="structpacket__t.html">packet_t</a>                pkt;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="comment">/* Packet contents/body */</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    uint8_t                 pktBody[PKT_BUF_SIZE];</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="comment">/* Count down counter between retries.  &lt; 0 means disabled. -2 means no more enabled beyond this. */</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordtype">int</span>                     counter;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">/* Port packet was sent on */</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordtype">int</span>                     pHandle;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;} <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a>;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">// ring buffer storage size</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#define RING_BUFFER_SIZE PKT_BUF_SIZE</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">// if ring buffer start index is less than this and no space is left, clear the entire ring buffer</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor">#define RING_BUFFER_FLUSH_THRESHOLD (RING_BUFFER_SIZE / 3)</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">// ring buffer struct for each pHandle in com manager</span></div><div class="line"><a name="l00103"></a><span class="lineno"><a class="line" href="structring__buffer__t.html">  103</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;{</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[RING_BUFFER_SIZE];</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    uint32_t startIndex;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    uint32_t endIndex;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    uint32_t scanIndex;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;} <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="structcom__manager__t.html">  111</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;{</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">// identifier for packets</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    uint8_t pktCounter;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="comment">// reads n bytes into buffer from the source (usually a serial port)</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    pfnComManagerRead readCallback;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment">// write data to the destination (usually a serial port)</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    pfnComManagerSend sendPacketCallback;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// bytes free in Tx buffer (used to check if packet, keeps us from overflowing the Tx buffer)</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    pfnComManagerSendBufferAvailableBytes txFreeCallback;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// Callback function pointer, used to respond to data input</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    pfnComManagerPostRead pstRxFnc;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment">// Callback function pointer, used to respond to ack</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    pfnComManagerPostAck pstAckFnc;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// Callback function pointer, used when disabling all broadcast messages</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    pfnComManagerDisableBroadcasts disableBcastFnc;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="comment">// Pointer to local data and data specific callback functions</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <a class="code" href="structregistered__data__t.html">registered_data_t</a> regData[DID_COUNT];</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="comment">// numHandles elements</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffers;                             </div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="comment">// ensured packets</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a>* ensuredPackets;      </div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">// handle ASCII messages not handled elsewhere</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    pfnComManagerAsciiMessageHandler asciiMessageHandler;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* asciiMessages;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    uint32_t asciiMessagesCount;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> msgs[MAX_NUM_BCAST_MSGS];</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* msgsHead;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* msgsTail;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    int32_t lastEnsuredPacketIndex;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// Number of communication ports</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    int32_t numHandes;                                          </div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="comment">// default is 2, max number of packets to ensured delivery at one time.  Adjust based on available memory.</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    int32_t maxEnsuredPackets;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="comment">// default is 2 - processing interval</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    int32_t stepPeriodMilliseconds;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// default is 3 - Ensure retry count</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    int32_t ensureRetryCount;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="comment">// current status, malloc for each possible port</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <a class="code" href="structcom__manager__status__t.html">com_manager_status_t</a>* status;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="comment">// user defined pointer</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">void</span>* userPointer;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">// pass through handler</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    pfnComManagerPassThrough passThroughHandler;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">// broadcast message handler</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    pfnComManagerBroadcast broadcastHandler;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor">#if ENABLE_PACKET_CONTINUATION</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="comment">// continuation data for packets</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <a class="code" href="structp__data__t.html">p_data_t</a>* con;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;} <a class="code" href="structcom__manager__t.html">com_manager_t</a>;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keyword">static</span> <a class="code" href="structcom__manager__t.html">com_manager_t</a> g_cm = { 0 };</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> g_validBaudRates[IS_BAUDRATE_COUNT] = {IS_BAUDRATE_3000000, IS_BAUDRATE_921600, IS_BAUDRATE_460800, IS_BAUDRATE_230400, IS_BAUDRATE_115200};</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    </div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordtype">void</span> initComManagerInstanceInternal</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;(</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance,</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordtype">int</span> numHandles,</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordtype">int</span> maxEnsuredPackets,</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">int</span> stepPeriodMilliseconds,</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordtype">int</span> retryCount,</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    pfnComManagerRead readFnc,</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    pfnComManagerSend sendFnc,</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    pfnComManagerSendBufferAvailableBytes txFreeFnc,</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    pfnComManagerPostRead pstRxFnc,</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    pfnComManagerPostAck pstAckFnc,</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    pfnComManagerDisableBroadcasts disableBcastFnc</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;);</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keywordtype">int</span> processAsciiRxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* start, <span class="keywordtype">int</span> count);</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordtype">void</span> parseAsciiPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> count);</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordtype">int</span> processBinaryRxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> additionalDataAvailable);</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keywordtype">void</span> enableBroadcastMsg(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *msg, <span class="keywordtype">int</span> period_ms);</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordtype">void</span> disableBroadcastMsg(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *msg);</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordtype">void</span> disableDidBroadcast(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structp__data__disable__t.html">p_data_disable_t</a> *disable);</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="keywordtype">int</span> sendPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *dPkt, uint8_t additionalPktFlags);</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="keywordtype">int</span> sendDataPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpkt__info__t.html">pkt_info_t</a> *msg);</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordtype">void</span> sendAck(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> pid_ack);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordtype">int</span> findAsciiMessage(<span class="keyword">const</span> <span class="keywordtype">void</span> * a, <span class="keyword">const</span> <span class="keywordtype">void</span> * b);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">//  Packet processing</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="keywordtype">int</span> encodeBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structbuffer__t.html">buffer_t</a> *pkt, <a class="code" href="structpacket__t.html">packet_t</a> *dPkt, uint8_t additionalPktFlags);</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keywordtype">int</span> decodeBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pbuf, <span class="keywordtype">int</span> pbufSize);</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="keywordtype">int</span> validateAsciiChecksum(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> count);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="keywordtype">int</span> processAsciiPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> dataLength);</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keywordtype">int</span> processBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* dataStart, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> dataLength, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* additionalDataAvailable);</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keywordtype">int</span> processPassThroughBytes(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer);</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keywordtype">int</span> beginUbloxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="keywordtype">int</span> beginRtcm3Packet(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordtype">int</span> decodeBinaryPacketByte(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, uint8_t** _ptrSrc, uint8_t** _ptrDest, uint32_t* checksum, uint32_t shift);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordtype">int</span> asciiMessageCompare(<span class="keyword">const</span> <span class="keywordtype">void</span>* elem1, <span class="keyword">const</span> <span class="keywordtype">void</span>* elem2);</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;uint8_t* encodeByteAddToBuffer(<span class="keywordtype">unsigned</span> val, uint8_t* ptrDest);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordtype">void</span> decodeBinaryPacketFooter24(<a class="code" href="structpacket__ftr__t.html">packet_ftr_t</a>* ftr, uint8_t* ptrSrc, uint8_t** ptrSrcEnd, uint32_t* checksum);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keywordtype">void</span> decodeBinaryPacketFooter16(<a class="code" href="structpacket__ftr__t.html">packet_ftr_t</a>* ftr, uint8_t** _ptrSrcEnd, uint32_t* checksum);</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordtype">void</span> swapPacket(<a class="code" href="structpacket__t.html">packet_t</a>* pkt);</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keywordtype">int</span> dataIdShouldSwap(uint32_t dataId);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">//  Packet Retry</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordtype">void</span> stepPacketRetry(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<a class="code" href="structpacket__t.html">packet_t</a>* registerPacketRetry(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, pkt_info_byte_t pid, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataSize);</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordtype">void</span> updatePacketRetryData(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structpacket__t.html">packet_t</a> *pkt);</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="keywordtype">void</span> updatePacketRetryAck(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structpacket__t.html">packet_t</a> *pkt);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="keywordtype">void</span> stepComManagerSendMessages(<span class="keywordtype">void</span>);</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="keywordtype">void</span> stepComManagerSendMessagesInstance(CMHANDLE cmInstance);</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;CMHANDLE getGlobalComManager(<span class="keywordtype">void</span>) { <span class="keywordflow">return</span> &amp;g_cm; }</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keywordtype">void</span> initComManager</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;(</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordtype">int</span> numHandles,</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordtype">int</span> maxEnsuredPackets,</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordtype">int</span> stepPeriodMilliseconds,</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordtype">int</span> retryCount,</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    pfnComManagerRead readFnc,</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    pfnComManagerSend sendFnc,</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    pfnComManagerSendBufferAvailableBytes txFreeFnc,</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    pfnComManagerPostRead pstRxFnc,</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    pfnComManagerPostAck pstAckFnc,</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    pfnComManagerDisableBroadcasts disableBcastFnc</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;)</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;{</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    initComManagerInstanceInternal(&amp;g_cm, numHandles, maxEnsuredPackets, stepPeriodMilliseconds, retryCount, readFnc, sendFnc, txFreeFnc, pstRxFnc, pstAckFnc, disableBcastFnc);</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;}</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;CMHANDLE initComManagerInstance</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;(</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordtype">int</span> numHandles,</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordtype">int</span> maxEnsuredPackets,</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordtype">int</span> stepPeriodMilliseconds,</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordtype">int</span> retryCount,</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    pfnComManagerRead readFnc,</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    pfnComManagerSend sendFnc,</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    pfnComManagerSendBufferAvailableBytes txFreeFnc,</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    pfnComManagerPostRead pstRxFnc,</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    pfnComManagerPostAck pstAckFnc,</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    pfnComManagerDisableBroadcasts disableBcastFnc</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;)</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;{</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structcom__manager__t.html">com_manager_t</a>));</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">while</span>( cmInstance==NULL ) { <span class="comment">/* Error check malloc */</span> }</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    memset(cmInstance, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcom__manager__t.html">com_manager_t</a>));</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    initComManagerInstanceInternal(cmInstance, numHandles, maxEnsuredPackets, stepPeriodMilliseconds, retryCount, readFnc, sendFnc, txFreeFnc, pstRxFnc, pstAckFnc, disableBcastFnc);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">return</span> cmInstance;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;}</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="keywordtype">void</span> initComManagerInstanceInternal</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;(</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance,</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordtype">int</span> numHandles,</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordtype">int</span> maxEnsuredPackets,</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordtype">int</span> stepPeriodMilliseconds,</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordtype">int</span> retryCount,</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    pfnComManagerRead readFnc,</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    pfnComManagerSend sendFnc,</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    pfnComManagerSendBufferAvailableBytes txFreeFnc,</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    pfnComManagerPostRead pstRxFnc,</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    pfnComManagerPostAck pstAckFnc,</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    pfnComManagerDisableBroadcasts disableBcastFnc</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;{</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    int32_t i;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    </div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordflow">if</span> (numHandles &lt; 0 || numHandles &gt; 1024)</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    {</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        numHandles = 1;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    }</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    </div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">// free ring buffers and ensured packet memory</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;ringBuffers != 0)</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    {</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        FREE(cmInstance-&gt;ringBuffers);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        cmInstance-&gt;ringBuffers = 0;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    }</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;ensuredPackets != 0)</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        FREE(cmInstance-&gt;ensuredPackets);</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        cmInstance-&gt;ensuredPackets = 0;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;status != 0)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        FREE(cmInstance-&gt;status);</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        cmInstance-&gt;status = 0;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    }</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    </div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">// assign new variables</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    cmInstance-&gt;maxEnsuredPackets = maxEnsuredPackets;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    cmInstance-&gt;readCallback = readFnc;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    cmInstance-&gt;sendPacketCallback = sendFnc;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    cmInstance-&gt;txFreeCallback = txFreeFnc;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    cmInstance-&gt;pstRxFnc = pstRxFnc;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    cmInstance-&gt;pstAckFnc = pstAckFnc;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    cmInstance-&gt;disableBcastFnc = disableBcastFnc;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    cmInstance-&gt;numHandes = numHandles;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    cmInstance-&gt;stepPeriodMilliseconds = stepPeriodMilliseconds;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    cmInstance-&gt;ensureRetryCount = retryCount;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">// Allocate ring buffers for serial reads / writes</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    cmInstance-&gt;ringBuffers = (<a class="code" href="structring__buffer__t.html">ring_buffer_t</a>*)MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structring__buffer__t.html">ring_buffer_t</a>) * numHandles);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    memset(cmInstance-&gt;ringBuffers, 0, <span class="keyword">sizeof</span>(<a class="code" href="structring__buffer__t.html">ring_buffer_t</a>) * numHandles);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="comment">// Allocate memory for ensured packets</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;maxEnsuredPackets &gt; 0)</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    {</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        cmInstance-&gt;ensuredPackets = MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a>) * cmInstance-&gt;maxEnsuredPackets);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        memset(cmInstance-&gt;ensuredPackets, 0, <span class="keyword">sizeof</span>(<a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a>) * cmInstance-&gt;maxEnsuredPackets);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        {</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            cmInstance-&gt;ensuredPackets[i].counter = -2; <span class="comment">// indicates no retries are enabled</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            cmInstance-&gt;ensuredPackets[i].pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = cmInstance-&gt;ensuredPackets[i].pktBody;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        }</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    }</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    cmInstance-&gt;status = MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structcom__manager__status__t.html">com_manager_status_t</a>) * numHandles);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    memset(cmInstance-&gt;status, 0, <span class="keyword">sizeof</span>(<a class="code" href="structcom__manager__status__t.html">com_manager_status_t</a>) * numHandles);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; numHandles; i++)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    {</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="preprocessor">#if PROTOCOL_VERSION_CHAR1 &gt; 1</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        cmInstance-&gt;status[i].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> = CPU_IS_LITTLE_ENDIAN | CM_PKT_FLAGS_CHECKSUM_24_BIT;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        cmInstance-&gt;status[i].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> = CPU_IS_LITTLE_ENDIAN;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    }</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="preprocessor">#if ENABLE_PACKET_CONTINUATION</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    cmInstance-&gt;con = MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structp__data__t.html">p_data_t</a>) * numHandles);</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    memset(cmInstance-&gt;con, 0, <span class="keyword">sizeof</span>(<a class="code" href="structp__data__t.html">p_data_t</a>) * numHandles);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;}</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keywordtype">int</span> asciiMessageCompare(<span class="keyword">const</span> <span class="keywordtype">void</span>* elem1, <span class="keyword">const</span> <span class="keywordtype">void</span>* elem2)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;{</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* e1 = (<a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>*)elem1;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* e2 = (<a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>*)elem2;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">return</span> memcmp(e1-&gt;<a class="code" href="structascii_message_map__t.html#a321bf44d43b7484a7b206741225a0a1a">messageId</a>, e2-&gt;<a class="code" href="structascii_message_map__t.html#a321bf44d43b7484a7b206741225a0a1a">messageId</a>, 4);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordtype">void</span> registerComManagerASCII(<a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* asciiMessages, <span class="keywordtype">int</span> asciiMessagesCount, pfnComManagerAsciiMessageHandler msgFnc)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;{</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    registerComManagerASCIIInstance(&amp;g_cm, asciiMessages, asciiMessagesCount, msgFnc);</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;}</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keywordtype">void</span> registerComManagerASCIIInstance(CMHANDLE cmInstance_, <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* asciiMessages, <span class="keywordtype">int</span> asciiMessagesCount, pfnComManagerAsciiMessageHandler msgFnc)</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;{</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance_;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    cmInstance-&gt;asciiMessages = asciiMessages;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    cmInstance-&gt;asciiMessagesCount = asciiMessagesCount;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    cmInstance-&gt;asciiMessageHandler = msgFnc;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    </div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="keywordflow">if</span> (asciiMessagesCount &gt; 1)</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    {</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        qsort(asciiMessages, <span class="keyword">sizeof</span>(asciiMessages[0]), asciiMessagesCount, asciiMessageCompare);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    }</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;}</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordtype">void</span> registerComManager(uint32_t dataId, pfnComManagerPreSend txFnc, pfnComManagerPostRead pstRxFnc, <span class="keywordtype">void</span>* txDataPtr, <span class="keywordtype">void</span>* rxDataPtr, <span class="keywordtype">int</span> dataSize, uint8_t pktFlags)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;{</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    registerComManagerInstance(&amp;g_cm, dataId, txFnc, pstRxFnc, txDataPtr, rxDataPtr, dataSize, pktFlags);</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="keywordtype">void</span> registerComManagerInstance(CMHANDLE cmInstance_, uint32_t dataId, pfnComManagerPreSend txFnc, pfnComManagerPostRead pstRxFnc, <span class="keywordtype">void</span>* txDataPtr, <span class="keywordtype">void</span>* rxDataPtr, <span class="keywordtype">int</span> dataSize, uint8_t pktFlags)</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;{</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance_;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="comment">// Validate ID and data pointer</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span> (dataId &gt;= DID_COUNT)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    }</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="comment">// Function called to update struct before data is sent</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    cmInstance-&gt;regData[dataId].preTxFnc = txFnc;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">// Function called after data is received and struct is updated</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    cmInstance-&gt;regData[dataId].pstRxFnc = pstRxFnc;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="comment">// Pointer to data struct for Tx</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    cmInstance-&gt;regData[dataId].dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#adb7fdcf7f9e8c13377db7643b67199b2">txPtr</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)txDataPtr;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">// Pointer to data struct for Rx</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    cmInstance-&gt;regData[dataId].dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#a3c8e53783acdd89e12c360315fbaac0e">rxPtr</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)rxDataPtr;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">// Size of data struct</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    cmInstance-&gt;regData[dataId].dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a> = dataSize;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    </div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="comment">// Packet flags</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    cmInstance-&gt;regData[dataId].pktFlags = pktFlags;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;}</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="keywordtype">void</span> stepComManager(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;{</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    stepComManagerInstance(&amp;g_cm);</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;}</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keywordtype">void</span> stepComManagerInstance(CMHANDLE cmInstance_)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;{</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance_;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    uint8_t c, additionalDataAvailable, canReadAgain;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    int32_t n, pHandle, freeByteCount;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;readCallback)</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    {</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="keywordflow">for</span> (pHandle = 0; pHandle &lt; cmInstance-&gt;numHandes; pHandle++)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            ringBuffer = cmInstance-&gt;ringBuffers + pHandle;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            canReadAgain = 1;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;readAgain:</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            freeByteCount = (RING_BUFFER_SIZE - ringBuffer-&gt;endIndex);</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            <span class="comment">// if we are out of free space, we need to either move bytes over or start over</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            <span class="keywordflow">if</span> (freeByteCount == 0)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            {</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                <span class="keywordflow">if</span> (ringBuffer-&gt;startIndex &lt; RING_BUFFER_FLUSH_THRESHOLD)</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                {</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                    <span class="comment">// we will be hung unless we flush the ring buffer, we have to drop bytes in this case and the caller</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                    <span class="comment">//  will need to resend the data</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    ringBuffer-&gt;startIndex = 0;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                    ringBuffer-&gt;endIndex = 0;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                    ringBuffer-&gt;scanIndex = 0;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                }</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                {</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                    <span class="comment">// shift over the remaining data in the hopes that we will get a valid packet by appending the next read call</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                    ringBuffer-&gt;endIndex -= ringBuffer-&gt;startIndex;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                    ringBuffer-&gt;scanIndex -= ringBuffer-&gt;startIndex;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                    memmove(ringBuffer-&gt;buf, ringBuffer-&gt;buf + ringBuffer-&gt;startIndex, ringBuffer-&gt;endIndex);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                    ringBuffer-&gt;startIndex = 0;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                }</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                <span class="comment">// re-calculate free byte count</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                freeByteCount = (RING_BUFFER_SIZE - ringBuffer-&gt;endIndex);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            }</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            <span class="keywordflow">if</span> ((n = cmInstance-&gt;readCallback(cmInstance, pHandle, ringBuffer-&gt;buf + ringBuffer-&gt;endIndex, freeByteCount)) &gt; 0)</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            {</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                additionalDataAvailable = 0;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += n;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                ringBuffer-&gt;endIndex += n;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                <span class="keywordflow">while</span> (ringBuffer-&gt;scanIndex &lt; ringBuffer-&gt;endIndex)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                {</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                    <span class="comment">// check for pass through bytes</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                    <span class="keywordflow">if</span> (cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a> &gt; 0)</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                    {</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                        processPassThroughBytes(cmInstance, pHandle, ringBuffer);</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                    }</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                    c = ringBuffer-&gt;buf[ringBuffer-&gt;scanIndex++];</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    <span class="keywordflow">switch</span> (c)</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    {</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                        <span class="keywordflow">case</span> PSC_ASCII_START_BYTE:</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                        {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                            cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = PSC_ASCII_START_BYTE;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                            ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex - 1;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                        <span class="keywordflow">case</span> PSC_START_BYTE:</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                        {</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                            cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = PSC_START_BYTE;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                            ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex - 1;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                        <span class="keywordflow">case</span> PSC_ASCII_END_BYTE:</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                        {</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                            <span class="keywordflow">if</span> (cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> == PSC_ASCII_START_BYTE)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                            {</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                                processAsciiPacket(cmInstance, pHandle, ringBuffer-&gt;buf + ringBuffer-&gt;startIndex, ringBuffer-&gt;scanIndex - ringBuffer-&gt;startIndex);</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                            }</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                            ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                            cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                        <span class="keywordflow">case</span> PSC_END_BYTE:</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                        {</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                            <span class="keywordflow">if</span> (cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> == PSC_START_BYTE)</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                            {</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                                processBinaryPacket(cmInstance, pHandle, ringBuffer-&gt;buf, ringBuffer-&gt;buf + ringBuffer-&gt;startIndex, ringBuffer-&gt;scanIndex - ringBuffer-&gt;startIndex, &amp;additionalDataAvailable);</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                            }</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                            ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                            cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                        <span class="keywordflow">case</span> UBLOX_START_BYTE1:</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                        {</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                            <span class="keywordflow">if</span> (beginUbloxPacket(cmInstance, pHandle, ringBuffer))</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                            {</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                            }</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                        <span class="keywordflow">case</span> RTCM3_START_BYTE:</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                        {</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                            <span class="keywordflow">if</span> (beginRtcm3Packet(cmInstance, pHandle, ringBuffer))</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                            {</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                            }</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                    }</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                }</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                <span class="keywordflow">if</span> (additionalDataAvailable &amp;&amp; canReadAgain)</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                {</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                    canReadAgain = 0;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                    <span class="keywordflow">goto</span> readAgain;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                }</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            }</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            </div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="keywordflow">if</span> ((cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> &amp; CM_PKT_FLAGS_RX_VALID_DATA) &amp;&amp; cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> &gt; 128)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            {</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                <span class="comment">// communication problem, clear communication received bit</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> &amp;= (~CM_PKT_FLAGS_RX_VALID_DATA);</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        }</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    }</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    stepComManagerSendMessagesInstance(cmInstance);</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;}</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordtype">void</span> stepComManagerSendMessages(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;{</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    stepComManagerSendMessagesInstance(&amp;g_cm);</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;}</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordtype">void</span> stepComManagerSendMessagesInstance(CMHANDLE cmInstance_)</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;{</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = cmInstance_;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    </div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="comment">// Send data (if necessary)</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* bcPtr = cmInstance-&gt;msgsHead;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="keywordflow">while</span> (bcPtr)</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    {</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <span class="comment">// Wait until buffer is empty enough.</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;txFreeCallback &amp;&amp; (bcPtr-&gt;pkt.txData.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &gt; (uint32_t)cmInstance-&gt;txFreeCallback(cmInstance, bcPtr-&gt;pHandle)))</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        {</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        }</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        <span class="comment">// Send once and remove from message queue</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bcPtr-&gt;period == MSG_PERIOD_SEND_ONCE)</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        {</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            sendDataPacket(cmInstance, bcPtr-&gt;pHandle, &amp;(bcPtr-&gt;pkt));</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            disableBroadcastMsg(cmInstance, bcPtr);</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        }</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">// Broadcast messages</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        {</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <span class="comment">// Check if counter has expired</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            <span class="keywordflow">if</span> (++bcPtr-&gt;counter &gt;= bcPtr-&gt;period)</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            {</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                bcPtr-&gt;counter = 0;    <span class="comment">// reset counter</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                <span class="comment">// Prep data if callback exists</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                <span class="keywordflow">if</span> (cmInstance-&gt;regData[bcPtr-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>].preTxFnc)</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                {</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                    cmInstance-&gt;regData[bcPtr-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>].preTxFnc(cmInstance, bcPtr-&gt;pHandle);</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                }</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                sendDataPacket(cmInstance, bcPtr-&gt;pHandle, &amp;(bcPtr-&gt;pkt));</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            }</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            <span class="comment">// Iterate to next message in message list</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            bcPtr = (<a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>*)bcPtr-&gt;llNxt;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        }       </div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    }</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="comment">// Resend data (if necessary)</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    stepPacketRetry(cmInstance);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;}</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordtype">void</span> freeComManagerInstance(CMHANDLE cmInstance_)</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;{</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordflow">if</span> (cmInstance_ != 0 &amp;&amp; cmInstance_ != &amp;g_cm)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    {</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance_;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;ringBuffers != 0)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        {</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            FREE(cmInstance-&gt;ringBuffers);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            cmInstance-&gt;ringBuffers = 0;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;ensuredPackets != 0)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        {</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            FREE(cmInstance-&gt;ensuredPackets);</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            cmInstance-&gt;ensuredPackets = 0;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        }</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;status != 0)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        {</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            FREE(cmInstance-&gt;status);</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            cmInstance-&gt;status = 0;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        }</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="preprocessor">#if ENABLE_PACKET_CONTINUATION</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;con != 0)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        {</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            FREE(cmInstance-&gt;con);</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            cmInstance-&gt;con = 0;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        }</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        FREE(cmInstance);</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    }</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;}</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="keywordtype">void</span> setComManagerPassThrough(pfnComManagerPassThrough handler)</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;{</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    setComManagerPassThroughInstance(&amp;g_cm, handler);</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;}</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordtype">void</span> setComManagerPassThroughInstance(CMHANDLE cmInstance, pfnComManagerPassThrough handler)</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;{</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">if</span> (cmInstance != 0)</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    {</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        ((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance)-&gt;passThroughHandler = handler;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    }</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;}</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordtype">void</span> setComManagerBroadcastCallback(pfnComManagerBroadcast handler)</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;{</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    setComManagerBroadcastCallbackInstance(&amp;g_cm, handler);</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;}</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordtype">void</span> setComManagerBroadcastCallbackInstance(CMHANDLE cmInstance, pfnComManagerBroadcast handler)</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;{</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">if</span> (cmInstance != 0)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    {</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        ((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance)-&gt;broadcastHandler = handler;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    }</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;}</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordtype">void</span> comManagerAssignUserPointer(CMHANDLE cmInstance, <span class="keywordtype">void</span>* userPointer)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;{</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    ((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance)-&gt;userPointer = userPointer;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;}</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">void</span>* comManagerGetUserPointer(CMHANDLE cmInstance)</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;{</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">return</span> ((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance)-&gt;userPointer;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;}</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<a class="code" href="structcom__manager__status__t.html">com_manager_status_t</a>* getStatusComManager(<span class="keywordtype">int</span> pHandle)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;{</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="keywordflow">return</span> getStatusComManagerInstance(&amp;g_cm, pHandle);</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;}</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<a class="code" href="structcom__manager__status__t.html">com_manager_status_t</a>* getStatusComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;{</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordflow">return</span> &amp;(((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance)-&gt;status[pHandle]);</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;}</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keywordtype">void</span> getDataComManager(<span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> period_ms)</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;{</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    getDataComManagerInstance(&amp;g_cm, pHandle, dataId, offset, size, period_ms);</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;}</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keywordtype">void</span> getDataComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> period_ms)</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;{</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <a class="code" href="structp__data__get__t.html">p_data_get_t</a> request;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> data;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="comment">// Create and Send request packet</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    request.<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a> = dataId;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    request.<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a> = offset;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    request.<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> = size;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    request.<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a> = period_ms;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)&amp;request;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(request);</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    sendComManagerInstance(cmInstance, pHandle, PID_GET_DATA, 0, &amp;data, 0);</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="comment">// sendEnsuredComManager(pHandle, PID_GET_DATA, (unsigned char*)&amp;request, sizeof(request));</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;}</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordtype">int</span> sendDataComManager(<span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span> *dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;{</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="keywordflow">return</span> sendDataComManagerInstance(&amp;g_cm, pHandle, dataId, dataPtr, dataSize, dataOffset);</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;}</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keywordtype">int</span> sendDataComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span>* dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;{</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> hdr;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> bodyHdr, data;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <span class="comment">// Data Header</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = dataId;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = dataSize;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = dataOffset;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="comment">// Packet Body</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)&amp;hdr;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(hdr);</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)dataPtr;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = dataSize;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keywordflow">return</span> sendComManagerInstance(cmInstance, pHandle, PID_SET_DATA, &amp;bodyHdr, &amp;data, 0);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="comment">// return sendEnsuredComManager(pHandle, PID_SET_DATA, &amp;bodyHdr, &amp;data);</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;}</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="keywordtype">int</span> sendDataComManagerNoAck(<span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span> *dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;{</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">return</span> sendDataComManagerNoAckInstance(&amp;g_cm, pHandle, dataId, dataPtr, dataSize, dataOffset);</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;}</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordtype">int</span> sendDataComManagerNoAckInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span>* dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;{</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> hdr;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> bodyHdr, data;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="comment">// Data Header</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = dataId;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = dataSize;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = dataOffset;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="comment">// Packet Body</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)&amp;hdr;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(hdr);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)dataPtr;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = dataSize;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordflow">return</span> sendComManagerInstance((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance, pHandle, PID_DATA, &amp;bodyHdr, &amp;data, 0);</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;}</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="keywordtype">int</span> sendRawDataComManager(<span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span> *dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;{</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="keywordflow">return</span> sendRawDataComManagerInstance(&amp;g_cm, pHandle, dataId, dataPtr, dataSize, dataOffset);</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;}</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="keywordtype">int</span> sendRawDataComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, uint32_t dataId, <span class="keywordtype">void</span>* dataPtr, <span class="keywordtype">int</span> dataSize, <span class="keywordtype">int</span> dataOffset)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;{</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> hdr;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> bodyHdr, data;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">// Data Header</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = dataId;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = dataSize;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    hdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = dataOffset;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="comment">// Packet Body</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)&amp;hdr;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    bodyHdr.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(hdr);</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t*)dataPtr;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = dataSize;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">return</span> sendComManagerInstance((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance, pHandle, PID_SET_DATA, &amp;bodyHdr, &amp;data, CM_PKT_FLAGS_RAW_DATA_NO_SWAP);</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;}</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="keywordtype">int</span> disableDataComManager(<span class="keywordtype">int</span> pHandle, uint32_t dataId)</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;{</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="keywordflow">return</span> disableDataComManagerInstance(&amp;g_cm, pHandle, dataId);</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;}</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="keywordtype">int</span> disableDataComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, uint32_t dataId)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;{</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> data;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>  = (uint8_t*)&amp;dataId;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = 4;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordflow">return</span> sendComManagerInstance(cmInstance, pHandle, PID_STOP_DID_BROADCAST, 0, &amp;data, 0);</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;}</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="keywordtype">int</span> sendComManager(<span class="keywordtype">int</span> pHandle, pkt_info_byte_t pktInfo, <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> *bodyHdr, <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> *txData, uint8_t pFlags)</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;{</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">return</span> sendComManagerInstance(&amp;g_cm, pHandle, pktInfo, bodyHdr, txData, pFlags);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;}</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="keywordtype">int</span> sendComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, pkt_info_byte_t pktInfo, <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a>* bodyHdr, <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a>* txData, uint8_t pktFlags)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;{</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <a class="code" href="structpkt__info__t.html">pkt_info_t</a> pkt;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    memset(&amp;pkt, 0, <span class="keyword">sizeof</span>(<a class="code" href="structpkt__info__t.html">pkt_info_t</a>));</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="comment">// Create Packet String (start to end byte)</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    pkt.hdr.<a class="code" href="structpacket__hdr__t.html#aae0969a547bd5ea711e2fe7e2d9a5f4e">startByte</a> = PSC_START_BYTE;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    pkt.hdr.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> = pktInfo;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    pkt.hdr.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> = pktFlags;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordflow">if</span> (bodyHdr)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    {</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        pkt.bodyHdr = *bodyHdr;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    }</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keywordflow">if</span> (txData)</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    {</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        pkt.txData = *txData;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    }</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="keywordflow">return</span> sendDataPacket(cmInstance, pHandle, &amp;pkt);</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;}</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="keywordtype">int</span> sendEnsuredComManager(<span class="keywordtype">int</span> pHandle, pkt_info_byte_t pktInfo, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataSize)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;{</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordflow">return</span> sendEnsuredComManagerInstance(&amp;g_cm, pHandle, pktInfo, data, dataSize);</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;}</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="keywordtype">int</span> sendEnsuredComManagerInstance(CMHANDLE cmInstance, <span class="keywordtype">int</span> pHandle, pkt_info_byte_t pktInfo, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataSize)</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;{</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <a class="code" href="structpacket__t.html">packet_t</a> *pkt;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="comment">// Change retry &quot;Ensured&quot; packets to so that we encode packets first (including pkt counter) </span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="comment">// and then ensure they are delivered.  Include packet checksum in ACK/NACK to validate delivery.</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="comment">// Then, if all the ensured slots are occupied because of bad comm, either allow</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">// to clear ensured packets or just block until they are delivered.  We must</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="comment">// ensure NACKs are used to clear blocking ensured packets.</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="comment">// Create Packet String (start to end byte)</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="keywordflow">if</span> ((pkt = registerPacketRetry((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance, pHandle, pktInfo, data, dataSize)) == 0)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    }</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="keywordflow">return</span> sendPacket((<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance, pHandle, pkt, 0);</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;}</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keywordtype">int</span> findAsciiMessage(<span class="keyword">const</span> <span class="keywordtype">void</span> * a, <span class="keyword">const</span> <span class="keywordtype">void</span> * b)</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;{</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* a1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)a;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* a2 = (<a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>*)b;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">return</span> memcmp(a1, a2-&gt;<a class="code" href="structascii_message_map__t.html#a321bf44d43b7484a7b206741225a0a1a">messageId</a>, 4);</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;}</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="keywordtype">int</span> validateAsciiChecksum(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> count)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;{</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="keywordtype">int</span> checkSum = 0;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* end = buf + count;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="comment">// Suppress compiler warnings</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    (void)cmInstance;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="comment">// calculate and validate the checksum, skipping the initial $ char</span></div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keywordflow">while</span> (buf != end)</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    {</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        c = *(++buf);</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        {</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            <span class="comment">// there must be at least four more chars - the checksum and \r\n to proceed</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            <span class="keywordflow">if</span> (buf + 4 &gt;= end)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;            {</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            }</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            <span class="keywordtype">char</span> tmp[3];</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;            tmp[0] = *(++buf);</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;            tmp[1] = *(++buf);</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;            tmp[2] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;            <span class="keywordtype">int</span> actualCheckSum = strtol(tmp, 0, 16);</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <span class="keywordflow">return</span> (checkSum == actualCheckSum);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        }</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        checkSum ^= c;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    }</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;}</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordtype">void</span> parseAsciiPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> count)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;{</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* messageId;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* messageData = 0;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* end = buf + count;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr = buf;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordtype">int</span> fieldIndex = 0;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="keywordtype">int</span> length;</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <a class="code" href="structascii_message_map__t.html">asciiMessageMap_t</a>* foundMap = 0;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> |= CM_PKT_FLAGS_RX_VALID_DATA; <span class="comment">// communication received</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> = 0;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="comment">// Packet read success</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a9b358bcb95013a3606a763c35a66538d">rxPktCount</a>++;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">// message id is right after the $ char</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    messageId = ++ptr;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="keywordflow">while</span> (ptr &lt; end)</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    {</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        c = *ptr;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;,&#39;</span> || c == <span class="charliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        {</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            <span class="keywordflow">if</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            (</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                <span class="comment">// global ascii handler gobbled up the message, we are done</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                (cmInstance-&gt;asciiMessageHandler != 0 &amp;&amp; cmInstance-&gt;asciiMessageHandler(cmInstance, pHandle, messageId, buf, count)) ||</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                <span class="comment">// no ascii messages defined, we are done</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                cmInstance-&gt;asciiMessages == 0 || cmInstance-&gt;asciiMessagesCount == 0 ||</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                <span class="comment">// no global handle and no data mapping for this message id, we are done</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                ((foundMap = bsearch(messageId, cmInstance-&gt;asciiMessages, cmInstance-&gt;asciiMessagesCount, <span class="keyword">sizeof</span>(cmInstance-&gt;asciiMessages[0]), findAsciiMessage)) == 0) ||</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                <span class="comment">// field count exceeded, we are done</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                (fieldIndex &gt;= foundMap-&gt;<a class="code" href="structascii_message_map__t.html#a9f826f57213df4538aa34db3d4513ab3">fieldCount</a>)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;            )</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;            {</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            }</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;            <span class="comment">// check if we have the first piece of data yet</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (messageData != 0)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;            {</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                <span class="comment">// if we have a non-empty message, parse it out</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                <span class="keywordflow">if</span> ((length = (<span class="keywordtype">int</span>)(ptr - messageData)) &gt; 0)</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                {</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                    *ptr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                    uint16_t fieldAndOffset = foundMap-&gt;<a class="code" href="structascii_message_map__t.html#aff37daca4dfc68b724b2837748dc4cd9">fieldsAndOffsets</a>[fieldIndex];</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                    asciiDataType type = (fieldAndOffset &amp; 0x00FF);</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                    uint8_t offset = (fieldAndOffset &amp; 0xFF00) &gt;&gt; 8;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                    <span class="keywordflow">switch</span> (type)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                    {</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                        <span class="keywordflow">case</span> asciiTypeInt:</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                        {</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">int</span> dataValue = strtol((<span class="keywordtype">char</span>*)messageData, 0, 10);</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                            memcpy(foundMap-&gt;<a class="code" href="structascii_message_map__t.html#a33d8b7845ee9c8d532fa5e22fadb9b37">ptr</a> + offset, &amp;dataValue, <span class="keyword">sizeof</span>(dataValue));</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                        <span class="keywordflow">case</span> asciiTypeUInt:</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                        {</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataValue = strtoul((<span class="keywordtype">char</span>*)messageData, 0, 10);</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                            memcpy(foundMap-&gt;<a class="code" href="structascii_message_map__t.html#a33d8b7845ee9c8d532fa5e22fadb9b37">ptr</a> + offset, &amp;dataValue, <span class="keyword">sizeof</span>(dataValue));</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                        <span class="keywordflow">case</span> asciiTypeFloat:</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                        {</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">float</span> dataValue = PARSE_FLOAT((<span class="keywordtype">char</span>*)messageData);</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                            memcpy(foundMap-&gt;<a class="code" href="structascii_message_map__t.html#a33d8b7845ee9c8d532fa5e22fadb9b37">ptr</a> + offset, &amp;dataValue, <span class="keyword">sizeof</span>(dataValue));</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                        <span class="keywordflow">case</span> asciiTypeDouble:</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                        {</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">double</span> dataValue = PARSE_DOUBLE((<span class="keywordtype">char</span>*)messageData);</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                            memcpy(foundMap-&gt;<a class="code" href="structascii_message_map__t.html#a33d8b7845ee9c8d532fa5e22fadb9b37">ptr</a> + offset, &amp;dataValue, <span class="keyword">sizeof</span>(dataValue));</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                    }</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                    *ptr = c;</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                }</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                fieldIndex++;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            }</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            <span class="comment">// next message data is at next char</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            messageData = ++ptr;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        }</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        {</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;            ptr++;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        }</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    }</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;}</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment">// Return value: 0 = success, -1 = error.</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="keywordtype">int</span> processAsciiRxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> count)</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;{</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">if</span> (count &lt; 10 || ((cmInstance-&gt;asciiMessages == 0 || cmInstance-&gt;asciiMessagesCount == 0) &amp;&amp; (cmInstance-&gt;asciiMessageHandler == 0)))</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    {</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    }</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="comment">// checksum check first, we don&#39;t want to start messing up memory or running commands if the checksum doesn&#39;t match</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="keywordflow">if</span> (validateAsciiChecksum(cmInstance, buf, count) == 0)</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    {</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += 32;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    }</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="comment">// parse the packet, it is probably good to go</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    parseAsciiPacket(cmInstance, pHandle, buf, count);</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;}</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="keywordtype">int</span> processBinaryRxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> additionalDataAvailable)</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;{</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    <a class="code" href="structp__data__t.html">p_data_t</a>            *data;</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>        *dataHdr;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    uint8_t             *dataBuf;</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <a class="code" href="structregistered__data__t.html">registered_data_t</a>   *regd;</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    pkt_info_byte_t     pid = (pkt_info_byte_t)(pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>);</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> |= CM_PKT_FLAGS_RX_VALID_DATA; <span class="comment">// communication received</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> = 0;</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="comment">// Packet read success</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a9b358bcb95013a3606a763c35a66538d">rxPktCount</a>++;</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="keywordflow">switch</span> (pid)</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    {</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="keywordflow">default</span>:    <span class="comment">// Data ID Unknown</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="keywordflow">case</span> PID_SET_DATA:</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="keywordflow">case</span> PID_DATA:</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        data = (<a class="code" href="structp__data__t.html">p_data_t</a>*)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>);</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        dataHdr = &amp;(data-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>);</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        dataBuf = data-&gt;<a class="code" href="structp__data__t.html#a006c80696cc8ad6e3699d853da9c9c07">buf</a>;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="comment">// Validate Data</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordflow">if</span> (dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> &gt;= DID_COUNT)</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        {</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        }</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        regd = &amp;(cmInstance-&gt;regData[dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>]);</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        <span class="comment">// Validate and constrain Rx data size to fit within local data struct</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="keywordflow">if</span> (regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a> &amp;&amp; (dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> + dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>) &gt; regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a>)</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        {</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            <span class="comment">// trim the size down so it fits</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            <span class="keywordtype">int</span> size = (int)(regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a> - dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>);</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            <span class="keywordflow">if</span> (size &lt; 4)</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            {</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                <span class="comment">// we are completely out of bounds, we cannot process this message at all</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                <span class="comment">// the minimum data struct size is 4 bytes</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            }</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;            <span class="comment">// Update Rx data size</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = _MIN(dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>, (uint8_t)size);</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        }</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="preprocessor">#if ENABLE_PACKET_CONTINUATION</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="comment">// Consolidate datasets that were broken-up across multiple packets</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        <a class="code" href="structp__data__t.html">p_data_t</a>* con = &amp;cmInstance-&gt;con[pHandle];</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="keywordflow">if</span> (additionalDataAvailable || (con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> != 0 &amp;&amp; con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>))</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        {</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="comment">// New dataset</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == 0 || con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> == 0 || con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> != dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> || con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> &gt; dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            {</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                <span class="comment">// Reset data consolidation</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = 0;</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            }</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            <span class="comment">// Ensure data will fit in buffer</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            <span class="keywordflow">if</span> ((con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> + dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>) &lt; <span class="keyword">sizeof</span>(con-&gt;<a class="code" href="structp__data__t.html#a006c80696cc8ad6e3699d853da9c9c07">buf</a>))</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            {</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                <span class="comment">// Add data to buffer</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                memcpy(con-&gt;<a class="code" href="structp__data__t.html#a006c80696cc8ad6e3699d853da9c9c07">buf</a> + con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>, dataBuf, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>);</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> += dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            }</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            {</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                <span class="comment">// buffer overflow</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;            <span class="comment">// Wait for end of data</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            <span class="keywordflow">if</span> (additionalDataAvailable)</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            {</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;            }</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            <span class="comment">// Use consolidated data</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;            data = con;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        }</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            </div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            </div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        (void)additionalDataAvailable;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="comment">// Write to data structure if it was registered</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        <span class="keywordflow">if</span> (regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#a3c8e53783acdd89e12c360315fbaac0e">rxPtr</a>)</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        {</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;            copyDataPToStructP(regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#a3c8e53783acdd89e12c360315fbaac0e">rxPtr</a>, data, regd-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a>);</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        }</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        <span class="comment">// Call data specific callback</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <span class="keywordflow">if</span> (regd-&gt;pstRxFnc)</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        {</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;            regd-&gt;pstRxFnc(cmInstance, pHandle, data);</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        }</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;        <span class="comment">// Call general/global callback </span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;pstRxFnc)</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        {</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;            cmInstance-&gt;pstRxFnc(cmInstance, pHandle, data);</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        }</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        <span class="comment">// Remove retry from linked list if necessary</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        updatePacketRetryData(cmInstance, pkt);</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="preprocessor">#if ENABLE_PACKET_CONTINUATION</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <span class="comment">// Clear dataset consolidation</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = con-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = 0;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        <span class="comment">// Replay w/ ACK for PID_SET_DATA</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="keywordflow">if</span> (pid == PID_SET_DATA)</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        {</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            sendAck(cmInstance, pHandle, pkt, PID_ACK);</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        }</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="keywordflow">case</span> PID_GET_DATA:</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <span class="keywordflow">if</span> (comManagerGetDataRequestInstance(cmInstance, pHandle, (<a class="code" href="structp__data__get__t.html">p_data_get_t</a> *)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>)))</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        {</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            sendAck(cmInstance, pHandle, pkt, PID_NACK);</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        }</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="keywordflow">case</span> PID_STOP_ALL_BROADCASTS:</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        disableAllBroadcastsInstance(cmInstance);</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        <span class="comment">// Call disable all broadcast callback if exists</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;disableBcastFnc)</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        {</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;            cmInstance-&gt;disableBcastFnc(cmInstance, pHandle);</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        }</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        sendAck(cmInstance, pHandle, pkt, PID_ACK);</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <span class="keywordflow">case</span> PID_STOP_DID_BROADCAST:</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        disableDidBroadcast(cmInstance, pHandle, (<a class="code" href="structp__data__disable__t.html">p_data_disable_t</a> *)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>));</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="keywordflow">case</span> PID_NACK:</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="keywordflow">case</span> PID_ACK:</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        <span class="comment">// Remove retry from linked list if necessary</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        updatePacketRetryAck(cmInstance, pkt);</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        <span class="comment">// Call general ack callback </span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;pstAckFnc)</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        {</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;            cmInstance-&gt;pstAckFnc(cmInstance, pHandle, (<a class="code" href="structp__ack__t.html">p_ack_t</a>*)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>), pid);</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        }</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    }</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;}</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;<a class="code" href="structbuf_tx_rx_ptr__t.html">bufTxRxPtr_t</a>* comManagerGetRegisteredDataInfo(uint32_t dataId)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;{</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="keywordflow">return</span> comManagerGetRegisteredDataInfoInstance(&amp;g_cm, dataId);</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;}</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<a class="code" href="structbuf_tx_rx_ptr__t.html">bufTxRxPtr_t</a>* comManagerGetRegisteredDataInfoInstance(CMHANDLE _cmInstance, uint32_t dataId)</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;{</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="keywordflow">if</span> (dataId &gt;= DID_COUNT)</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    {</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    }</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)_cmInstance;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="keywordflow">return</span> &amp;cmInstance-&gt;regData[dataId].dataSet;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;}</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="comment">// 0 on success. -1 on failure.</span></div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="keywordtype">int</span> comManagerGetDataRequest(<span class="keywordtype">int</span> pHandle, <a class="code" href="structp__data__get__t.html">p_data_get_t</a>* req)</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;{</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">return</span> comManagerGetDataRequestInstance(&amp;g_cm, pHandle, req);</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;}</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="keywordtype">int</span> comManagerGetDataRequestInstance(CMHANDLE _cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structp__data__get__t.html">p_data_get_t</a>* req)</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;{</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)_cmInstance;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* msg = 0;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <span class="keywordtype">int</span> i;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="comment">// Validate the request</span></div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a> &gt;= DID_COUNT)</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    {</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    }</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="comment">// Constrain request broadcast period if necessary</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a> != 0)</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    {</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        _LIMIT2(req-&gt;<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a>, MIN_REQUEST_PERIOD_MS, MAX_REQUEST_PERIOD_MS);</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    }</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="comment">// if size is 0 and offset is 0, set size to full data struct size</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> == 0 &amp;&amp; req-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a> == 0 &amp;&amp; req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a> &lt; _ARRAY_ELEMENT_COUNT(cmInstance-&gt;regData))</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    {</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> = cmInstance-&gt;regData[req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a>].dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a>;</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    }</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    <span class="comment">// Search for matching message (i.e. matches pHandle, id, size, and offset)...</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_NUM_BCAST_MSGS; i++)</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    {</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;msgs[i].pHandle == pHandle &amp;&amp;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;            cmInstance-&gt;msgs[i].dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a> &amp;&amp;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;            cmInstance-&gt;msgs[i].dataHdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> == req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> &amp;&amp;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;            cmInstance-&gt;msgs[i].dataHdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> == req-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;            )</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        {</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;            msg = &amp;cmInstance-&gt;msgs[i];</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        }</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    }</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="comment">// otherwise use the first available (period=0) message.</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">if</span> (msg == 0)</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    {</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; MAX_NUM_BCAST_MSGS; i++)</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        {</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            <span class="keywordflow">if</span> (cmInstance-&gt;msgs[i].period == MSG_PERIOD_DISABLED)</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            {</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                msg = &amp;cmInstance-&gt;msgs[i];</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            }</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        }</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        <span class="comment">// Abort if we ran out of broadcast message slots</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        <span class="keywordflow">if</span> (msg == 0)</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;        {</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        }</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    }</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="comment">// Copy reference to source data</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    msg-&gt;dataSet = cmInstance-&gt;regData[req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a>].dataSet;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="comment">// Abort if no data pointer is registered or offset + size is out of bounds</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    <span class="keywordflow">if</span> (msg-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#adb7fdcf7f9e8c13377db7643b67199b2">txPtr</a> == 0 || msg-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a> == 0 || req-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a> + req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> &gt; msg-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">size</a>)</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    {</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    }</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="comment">// Port handle</span></div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    msg-&gt;pHandle = pHandle;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="comment">// Packet parameters</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    msg-&gt;pkt.hdr.<a class="code" href="structpacket__hdr__t.html#aae0969a547bd5ea711e2fe7e2d9a5f4e">startByte</a> = PSC_START_BYTE;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    msg-&gt;pkt.hdr.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> = PID_DATA;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="comment">// Data Header</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> = req-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a>;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> = req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a>;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> = req-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a>;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    msg-&gt;pkt.hdr.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> = cmInstance-&gt;regData[msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>].pktFlags;</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    msg-&gt;pkt.bodyHdr.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (uint8_t *)&amp;msg-&gt;dataHdr;</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    msg-&gt;pkt.bodyHdr.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(msg-&gt;dataHdr);</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    msg-&gt;pkt.txData.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = req-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a>;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    msg-&gt;pkt.txData.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = msg-&gt;dataSet.<a class="code" href="structbuf_tx_rx_ptr__t.html#adb7fdcf7f9e8c13377db7643b67199b2">txPtr</a> + req-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a>;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <span class="comment">// Prep data if callback exists</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;regData[msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>].preTxFnc)</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    {</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        cmInstance-&gt;regData[msg-&gt;dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>].preTxFnc(cmInstance, pHandle);</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    }</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    <span class="comment">// Send data</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a> &gt; 0)</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    {   </div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        <span class="comment">// ***  Request Broadcast  ***</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        <span class="comment">// Send data immediately if possible</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;txFreeCallback == 0 || msg-&gt;pkt.txData.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &lt;= (uint32_t)cmInstance-&gt;txFreeCallback(cmInstance, pHandle))</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        {</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;            sendDataPacket(cmInstance, pHandle, &amp;(msg-&gt;pkt));</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        }</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        <span class="comment">// Enable broadcast message</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        enableBroadcastMsg(cmInstance, msg, req-&gt;<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a>);</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    }</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    {   </div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        <span class="comment">// ***  Request Single  ***</span></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;        <span class="comment">// Send data immediately if possible</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;txFreeCallback == 0 || msg-&gt;pkt.txData.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &lt;= (uint32_t)cmInstance-&gt;txFreeCallback(cmInstance, pHandle))</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        {</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;            sendDataPacket(cmInstance, pHandle, &amp;(msg-&gt;pkt));</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            disableBroadcastMsg(cmInstance, msg);</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;        }</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        {</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;            <span class="comment">// Won&#39;t fit in queue, so send it later</span></div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            enableBroadcastMsg(cmInstance, msg, req-&gt;<a class="code" href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">bc_period_ms</a>);</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        }</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    }</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;broadcastHandler != 0)</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    {</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        cmInstance-&gt;broadcastHandler(cmInstance, pHandle, req);</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    }</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;}</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="keywordtype">void</span> enableBroadcastMsg(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *msg, <span class="keywordtype">int</span> period_ms)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;{</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="comment">// Add to linked list if not already running</span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordflow">if</span> (msg-&gt;period == MSG_PERIOD_DISABLED)</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    {</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;msgsHead)</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;        {</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;            <span class="comment">// Non-empty linked list.  Add to head of linked list</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;            cmInstance-&gt;msgsHead-&gt;llPrv = msg;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;            msg-&gt;llNxt = cmInstance-&gt;msgsHead;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;            cmInstance-&gt;msgsHead = msg;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        }</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        {   <span class="comment">// Empty linked list.  Add to head.</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            cmInstance-&gt;msgsHead = msg;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            cmInstance-&gt;msgsTail = msg;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        }</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    }</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="comment">// Update broadcast period</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">if</span> (period_ms &gt; 0)</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    {</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        msg-&gt;period = period_ms / cmInstance-&gt;stepPeriodMilliseconds;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    }</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    {</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        msg-&gt;period = MSG_PERIOD_SEND_ONCE;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    }</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    msg-&gt;counter = -1;   <span class="comment">// Keeps broadcast from sending for at least one period</span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;}</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="keywordtype">void</span> disableBroadcastMsg(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *msg)</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;{</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    <span class="comment">// Remove item from linked list</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* llPrv = (<a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>*)msg-&gt;llPrv;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>* llNxt = (<a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>*)msg-&gt;llNxt;</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="keywordflow">if</span> (llPrv)   llPrv-&gt;llNxt = llNxt;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    <span class="keywordflow">if</span> (llNxt)   llNxt-&gt;llPrv = llPrv;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    msg-&gt;llPrv = 0;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    msg-&gt;llNxt = 0;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="comment">// Update Head pointer if needed</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;msgsHead == msg)</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    {</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        cmInstance-&gt;msgsHead = llNxt;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    }</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    <span class="comment">// Update Tail pointer if needed</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;msgsTail == msg)</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    {</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        cmInstance-&gt;msgsTail = llPrv;</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    }</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    <span class="comment">// Disabled indicator</span></div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    msg-&gt;period = MSG_PERIOD_DISABLED;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;}</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;<span class="keywordtype">void</span> disableAllBroadcasts(<span class="keywordtype">void</span>)</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;{</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    disableAllBroadcastsInstance(&amp;g_cm);</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;}</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;<span class="keywordtype">void</span> disableAllBroadcastsInstance(CMHANDLE cmInstance_)</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;{</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance = (<a class="code" href="structcom__manager__t.html">com_manager_t</a>*)cmInstance_;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *msg = cmInstance-&gt;msgsHead;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a> *llNxt;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <span class="comment">// Zero out the head and tail pointers.</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    cmInstance-&gt;msgsHead = 0;</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    cmInstance-&gt;msgsTail = 0;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    <span class="comment">// Ensure period and the previous/next linked list pointers are 0.</span></div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="keywordflow">while</span> (msg)</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    {</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        llNxt = (<a class="code" href="structbroadcast__msg__t.html">broadcast_msg_t</a>*)msg-&gt;llNxt;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        msg-&gt;llPrv = msg-&gt;llNxt = 0;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        msg-&gt;period = MSG_PERIOD_DISABLED;</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        msg = llNxt;</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    }</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;}</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;<span class="keywordtype">void</span> disableDidBroadcast(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structp__data__disable__t.html">p_data_disable_t</a> *disable)</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;{</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="keywordtype">int</span> i;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="comment">// Search for matching message by ID</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_NUM_BCAST_MSGS; i++)</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    {</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;msgs[i].dataHdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == disable-&gt;<a class="code" href="structp__data__disable__t.html#aca2ef5d5ec699f32fe117e470f6c1986">id</a> &amp;&amp; cmInstance-&gt;msgs[i].pHandle == pHandle)</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        {</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            disableBroadcastMsg(cmInstance, &amp;cmInstance-&gt;msgs[i]);</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        }</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    }</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;}</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="keywordtype">int</span> sendPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *dPkt, uint8_t additionalPktFlags)</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;{</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    <a class="code" href="structbuffer__t.html">buffer_t</a> buffer;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    <span class="keywordflow">if</span> (encodeBinaryPacket(cmInstance, pHandle, &amp;buffer, dPkt, additionalPktFlags))</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    {</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    }</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <span class="comment">// Send Packet</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmInstance-&gt;sendPacketCallback)</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    {</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;        cmInstance-&gt;sendPacketCallback(cmInstance, pHandle, &amp;buffer);</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    }</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a0ad6d483eb2fbd825a90a518dad9e0ce">txPktCount</a>++;</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;}</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">// Consolidate this with sendPacket() so that we break up packets into multiples that fit our buffer size.</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="keywordtype">int</span> sendDataPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpkt__info__t.html">pkt_info_t</a>* msg)</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;{</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;    pfnComManagerSend sendCallback = cmInstance-&gt;sendPacketCallback;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <span class="keywordflow">if</span> (sendCallback == 0)</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    {</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    }</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    <a class="code" href="structbuffer__t.html">buffer_t</a> bufToSend;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    <a class="code" href="structpacket__t.html">packet_t</a> pkt;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a> = msg-&gt;hdr;</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    <span class="keywordflow">switch</span> (pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>)</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    {</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        <span class="comment">// Large data support - breaks data up into separate packets for Tx</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        <span class="keywordflow">case</span> PID_DATA:</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <span class="keywordflow">case</span> PID_SET_DATA:</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        {</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;            <span class="comment">// Setup packet and encoding state</span></div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;            <a class="code" href="structbuffer__t.html">buffer_t</a> bufToEncode;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;            <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> hdr = *(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)msg-&gt;bodyHdr.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;            <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>* hdrToSend = (<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)bufToEncode.<a class="code" href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buf</a>;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;            uint32_t size = hdr.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;            uint32_t offset = 0;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;            uint32_t <span class="keywordtype">id</span> = hdr.<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;            pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = bufToEncode.<a class="code" href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buf</a>;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;            <span class="keywordflow">while</span> (size &gt; 0)</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;            {</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                <span class="comment">// Assign data header values</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                hdrToSend-&gt;size = _MIN(size, MAX_P_DATA_BODY_SIZE);</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                hdrToSend-&gt;offset = hdr.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> + offset;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                hdrToSend-&gt;id = id;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                <span class="comment">// copy the data to send to bufToEncode, skipping the data header - since we had to create that data header, we now have to append the actual data</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                memcpy(bufToEncode.<a class="code" href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buf</a> + <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>), msg-&gt;txData.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> + offset, hdrToSend-&gt;size);</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;                <span class="comment">// adjust size and offset values in case we have another piece of this packet to send</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                size -= hdrToSend-&gt;size;</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                offset += hdrToSend-&gt;size;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                <span class="comment">// Set data body size</span></div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>) + hdrToSend-&gt;size;</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                <span class="comment">// Encode the packet, handling special characters, etc.</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                if (encodeBinaryPacket(cmInstance, pHandle, &amp;bufToSend, &amp;pkt, CM_PKT_FLAGS_MORE_DATA_AVAILABLE * (size != 0)))</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                {</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                }</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                <span class="comment">// Send the packet using the specified callback</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                sendCallback(cmInstance, pHandle, &amp;bufToSend);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;                cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a0ad6d483eb2fbd825a90a518dad9e0ce">txPktCount</a>++;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;            }</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        <span class="comment">// Single packet commands/data sets. No data header, just body.</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        {</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;            <span class="comment">// Assign packet pointer and encode data as is</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;            pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a> = msg-&gt;txData;</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;            <span class="keywordflow">if</span> (encodeBinaryPacket(cmInstance, pHandle, &amp;bufToSend, &amp;pkt, 0))</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;            {</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;            <span class="comment">// Send the packet using the specified callback</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            sendCallback(cmInstance, pHandle, &amp;bufToSend);</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a0ad6d483eb2fbd825a90a518dad9e0ce">txPktCount</a>++;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    }</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;}</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;<span class="keywordtype">void</span> sendAck(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a> *pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> pid_ack)</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;{</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;    <span class="keywordtype">int</span> ackSize;</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    <a class="code" href="structbuf_ptr__t.html">bufPtr_t</a> data;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    <span class="comment">// Create and Send request packet</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <a class="code" href="structp__ack__t.html">p_ack_t</a> ack;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;    ack.<a class="code" href="structp__ack__t.html#abf05e90920db88b6ca818740dde82dc6">hdr</a>.<a class="code" href="structp__ack__hdr__t.html#a9c409a6deaf6d6bb1c8e1d2b73b3bf34">pktInfo</a> = pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    ack.<a class="code" href="structp__ack__t.html#abf05e90920db88b6ca818740dde82dc6">hdr</a>.<a class="code" href="structp__ack__hdr__t.html#a6e047dce01db1c893021485be63cbb6f">pktCounter</a> = pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a5e22ca5884ff79547cdaf5577cad9f41">counter</a>;</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    ackSize = <span class="keyword">sizeof</span>(<a class="code" href="structp__ack__hdr__t.html">p_ack_hdr_t</a>);</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="comment">// Set ack body</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <span class="keywordflow">switch</span> (pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>)</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;    {</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keywordflow">case</span> PID_SET_DATA:</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        memcpy(&amp;(ack.<a class="code" href="structp__ack__t.html#a2c304755ebea9c13682813a6edd44a1a">buf</a>), (<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>), <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>));</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        ackSize += <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>);</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    }</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;ack;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    data.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = ackSize;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    sendComManagerInstance(cmInstance, pHandle, (pkt_info_byte_t)pid_ack, 0, &amp;data, 0);</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;}</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;<span class="comment">// Replace special character with encoded equivalent and add to buffer</span></div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;uint8_t* encodeByteAddToBuffer(<span class="keywordtype">unsigned</span> val, uint8_t* ptrDest)</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;{</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    <span class="keywordflow">switch</span> (val)</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    {</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        <span class="keywordflow">case</span> PSC_ASCII_START_BYTE: </div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <span class="keywordflow">case</span> PSC_ASCII_END_BYTE: </div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <span class="keywordflow">case</span> PSC_START_BYTE: </div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        <span class="keywordflow">case</span> PSC_END_BYTE: </div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        <span class="keywordflow">case</span> PSC_RESERVED_KEY:</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;        <span class="keywordflow">case</span> UBLOX_START_BYTE1:</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        <span class="keywordflow">case</span> RTCM3_START_BYTE:</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;            *ptrDest++ = PSC_RESERVED_KEY;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;            *ptrDest++ = ~val;</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;            *ptrDest++ = val;</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;    }</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    </div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;    <span class="keywordflow">return</span> ptrDest;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;}</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="comment">//  Packet Composition</span></div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="keywordtype">int</span> encodeBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structbuffer__t.html">buffer_t</a> *pkt, <a class="code" href="structpacket__t.html">packet_t</a> *dPkt, uint8_t additionalPktFlags)</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;{</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="comment">// Ensure data size is small enough, assuming packet size could double after encoding.</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="keywordflow">if</span> (dPkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &gt; MAX_PKT_BODY_SIZE)</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    {</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    }</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;    <span class="comment">// Update Packet Counter</span></div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;    dPkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a5e22ca5884ff79547cdaf5577cad9f41">counter</a> = cmInstance-&gt;pktCounter++;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    uint8_t* ptrSrc;</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    uint8_t* ptrSrcEnd;</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;    uint8_t* ptrDest = pkt-&gt;<a class="code" href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buf</a>;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;    <span class="keywordtype">unsigned</span> shifter = (PROTOCOL_VERSION_CHAR1 &gt; 1 ? 0 : 8);</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;    <span class="keywordtype">unsigned</span> checkSumValue = (PROTOCOL_VERSION_CHAR1 &gt; 1 ? CHECKSUM_SEED  : 0x0000FF00);</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;    <span class="keywordtype">unsigned</span> val;</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;    <span class="comment">// Packet header -------------------------------------------------------------------------------------------</span></div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;    *ptrDest++ = PSC_START_BYTE;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;    <span class="comment">// PID</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;    val = dPkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>;</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;    checkSumValue ^= val;</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    </div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    <span class="comment">// Counter</span></div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;    val = dPkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a5e22ca5884ff79547cdaf5577cad9f41">counter</a>;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;    checkSumValue ^= (val &lt;&lt; 8);</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;    </div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;    <span class="comment">// Flags</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;    val = cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">flags</a> | dPkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> | additionalPktFlags;</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    checkSumValue ^= (PROTOCOL_VERSION_CHAR1 &gt; 1 ? val &lt;&lt; 16 : val);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    <span class="comment">// Packet body ----------------------------------------------------------------------------------------------</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;    ptrSrc = (uint8_t*)dPkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>;</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    ptrSrcEnd = ptrSrc + dPkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a>;</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="comment">// copy body bytes, doing encoding and checksum</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    while (ptrSrc != ptrSrcEnd)</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    {</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        val = *ptrSrc++;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;        checkSumValue ^= (val &lt;&lt; shifter);</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="preprocessor">#if PROTOCOL_VERSION_CHAR1 &gt; 1</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;        <span class="comment">// increment shifter</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;        shifter += 8;</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;        <span class="comment">// reset if shifter equals 24</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;        shifter *= (shifter != 24);</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        shifter ^= 8;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;    }</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    </div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    <span class="comment">// footer ----------------------------------------------------------------------------------------------------</span></div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="preprocessor">#if PROTOCOL_VERSION_CHAR1 &gt; 1</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    <span class="comment">// checksum byte 3</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;    val = (uint8_t)((checkSumValue &gt;&gt; 16) &amp; 0xFF);</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    *ptrDest++ = 0; <span class="comment">// reserved</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;    </div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    <span class="comment">// checksum byte 2</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;    val = (uint8_t)(checkSumValue &gt;&gt; 8) &amp; 0xFF;</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    </div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;    <span class="comment">// checksum byte 1</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;    val = (uint8_t)(checkSumValue &amp; 0xFF);</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;    ptrDest = encodeByteAddToBuffer(val, ptrDest);</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <span class="comment">// packet end byte</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    *ptrDest++ = PSC_END_BYTE;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;    pkt-&gt;<a class="code" href="structbuffer__t.html#ab1ce0deb7a33566b5c9e2705ae822007">size</a> = (uint32_t)(ptrDest - pkt-&gt;<a class="code" href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buf</a>);</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;}</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="keywordtype">void</span> decodeBinaryPacketFooter24(<a class="code" href="structpacket__ftr__t.html">packet_ftr_t</a>* ftr, uint8_t* ptrSrc, uint8_t** ptrSrcEnd, uint32_t* checksum)</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;{</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="keywordtype">int</span> state = 0;</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    uint8_t* currentPtr = (*ptrSrcEnd) - 1;</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    *(uint32_t*)ftr = 0;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    <span class="comment">// we need a state machine to ensure we don&#39;t overrun ptrSrcEnd</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    <span class="keywordflow">while</span> (state != 7 &amp;&amp; currentPtr &gt; ptrSrc)</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    {</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        <span class="keywordflow">switch</span> (state)</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;        {</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        <span class="keywordflow">case</span> 0: <span class="comment">// packet end byte</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a7065d9b4532287ac5d3f18c9f7bef735">stopByte</a> = *currentPtr--;</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;            state = 1;</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        <span class="keywordflow">case</span> 1: <span class="comment">// packet checksum 1</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a> = *currentPtr--;</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;            state = (3 - (*currentPtr == PSC_RESERVED_KEY));</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        <span class="keywordflow">case</span> 2: <span class="comment">// packet checksum 1 is encoded</span></div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a>;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;            currentPtr--;</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;            state = 3;</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        <span class="keywordflow">case</span> 3: <span class="comment">// packet checksum 2</span></div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = *currentPtr--;</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;            state = (5 - (*currentPtr == PSC_RESERVED_KEY));</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="keywordflow">case</span> 4: <span class="comment">// packet checksum 2 is encoded</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a>;</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;            currentPtr--;</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;            state = 5;</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;        <span class="keywordflow">case</span> 5: <span class="comment">// packet checksum 3</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = *currentPtr;</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;            state = (7 - (*(currentPtr - 1) == PSC_RESERVED_KEY));</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;        <span class="keywordflow">case</span> 6: <span class="comment">// packet checksum 3 is encoded</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a>;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;            currentPtr--;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;            state = 7;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;        }</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    }</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    *ptrSrcEnd = currentPtr;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    *checksum = ((unsigned)ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a>) | (0x0000FF00 &amp; ((unsigned)ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> &lt;&lt; 8)) | (0x00FF0000 &amp; ((<span class="keywordtype">unsigned</span>)ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> &lt;&lt; 16));</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;}</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="keywordtype">void</span> decodeBinaryPacketFooter16(<a class="code" href="structpacket__ftr__t.html">packet_ftr_t</a>* ftr, uint8_t** _ptrSrcEnd, uint32_t* checksum)</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;{</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    uint8_t* ptrSrcEnd = *_ptrSrcEnd;</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    <span class="comment">// decode the footer first, accounting for special bytes</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a7065d9b4532287ac5d3f18c9f7bef735">stopByte</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    <span class="keywordflow">if</span> (ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> == PSC_RESERVED_KEY)</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    {</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;        ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a>;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;        ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;        ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <span class="keywordflow">if</span> (ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> == PSC_RESERVED_KEY)</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;        {</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a>;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;        }</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    }</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    {</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;        ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;        <span class="keywordflow">if</span> (ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> == PSC_RESERVED_KEY)</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;        {</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> = ~ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a>;</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;            ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">cksum3</a> = *(--ptrSrcEnd);</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        }</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;    }</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    *checksum = ((unsigned)ftr-&gt;<a class="code" href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">cksum2</a> &lt;&lt; 8) | (unsigned)ftr-&gt;<a class="code" href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">cksum1</a>;</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    *_ptrSrcEnd = ptrSrcEnd;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;}</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="keywordtype">void</span> swapPacket(<a class="code" href="structpacket__t.html">packet_t</a>* pkt)</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;{</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> &amp; CM_PKT_FLAGS_RAW_DATA_NO_SWAP)</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    {</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;        <span class="keywordflow">if</span> ((pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> == PID_DATA || pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> == PID_SET_DATA) &amp;&amp; pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &gt;= <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>))</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;        {</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;            <span class="comment">// swap the data header only</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;            flipEndianess32(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>, <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>));</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;        }</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    }</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>) || (pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> != PID_DATA &amp;&amp; pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> != PID_SET_DATA))</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    {</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        <span class="comment">// swap entire packet, not a data packet</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        flipEndianess32(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>, pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a>);</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    }</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    {</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        <span class="comment">// swap header</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        flipEndianess32(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>, <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>));</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        <span class="comment">// get header</span></div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>* dataHdr = (<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;        <span class="comment">// if dev_info_t, swap only the uint32 fields, this data structure is handled special as it contains char[] arrays and uint32_t in the same struct</span></div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;        if (dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == DID_DEV_INFO &amp;&amp; pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> == <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>) + <span class="keyword">sizeof</span>(dev_info_t))</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;        {</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;            <span class="comment">// swap only the pieces that need swapping</span></div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;            dev_info_t* devInfo = (dev_info_t*)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> + <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>));</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;            devInfo-&gt;buildNumber = SWAP32(devInfo-&gt;buildNumber);</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;            devInfo-&gt;repoRevision = SWAP32(devInfo-&gt;repoRevision);</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;            devInfo-&gt;serialNumber = SWAP32(devInfo-&gt;serialNumber);</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        }</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dataIdShouldSwap(dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>))</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        {</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;            <span class="comment">// swap entire packet body</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;            flipEndianess32(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> + <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>), pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>));</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;                </div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;            <span class="comment">// flip doubles</span></div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;            uint16_t* offsets;</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;            uint16_t offsetsLength;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;            uint8_t* dataBuf = pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> + <span class="keyword">sizeof</span>(<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>);</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;            <span class="comment">// flip doubles back if needed</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;            <span class="keywordflow">if</span> ((offsets = getDoubleOffsets(dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>, &amp;offsetsLength)))</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;            {</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;                flipDoubles(dataBuf, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>, offsets, offsetsLength);</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;            }</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;            <span class="comment">// flip strings back if needed</span></div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;            <span class="keywordflow">if</span> ((offsets = getStringOffsetsLengths(dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a>, &amp;offsetsLength)))</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;            {</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;                flipStrings(dataBuf, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>, offsets, offsetsLength);</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;            }</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;        }</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    }</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;}</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;INLINE <span class="keywordtype">int</span> dataIdShouldSwap(uint32_t dataId)</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;{</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    <span class="keywordflow">switch</span> (dataId)</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;    {</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;        <span class="keywordflow">case</span> DID_GPS_VERSION: <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    }</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;}</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;INLINE <span class="keywordtype">int</span> decodeBinaryPacketByte(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, uint8_t** _ptrSrc, uint8_t** _ptrDest, uint32_t* checksum, uint32_t shift)</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;{</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    uint8_t* ptrSrc = *_ptrSrc;</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    <span class="comment">// packet id byte</span></div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    uint32_t val = *ptrSrc++;</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    <span class="keywordflow">switch</span> (val)</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    {</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">case</span> PSC_ASCII_START_BYTE:</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    <span class="keywordflow">case</span> PSC_ASCII_END_BYTE:</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <span class="keywordflow">case</span> PSC_START_BYTE:</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="keywordflow">case</span> PSC_END_BYTE:</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;        <span class="comment">// corrupt data</span></div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += 32;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <span class="keywordflow">case</span> PSC_RESERVED_KEY:</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        <span class="comment">// skip special byte</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;        val = (~(*ptrSrc++) &amp; 0x000000FF);</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;        <span class="comment">// fall through intentional</span></div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        *checksum ^= (val &lt;&lt; shift);</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        *((*_ptrDest)++) = val;</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;    }</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    *_ptrSrc = ptrSrc;</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;}</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="keywordtype">int</span> decodeBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structpacket__t.html">packet_t</a>* pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pbuf, <span class="keywordtype">int</span> pbufSize)</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;{</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <span class="comment">// before we even get in this method, we can be assured that pbuf starts with a packet start byte and ends with a packet end byte</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;    <span class="comment">// all other data can potentially be garbage</span></div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;    <span class="keywordflow">if</span> (pbufSize &lt; 8)</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;    {</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;        <span class="comment">// corrupt data</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += 32;</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    }</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;    <span class="comment">// decode the body and calculate checksum</span></div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    uint8_t* ptrSrc = pbuf;</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    uint8_t* ptrDest = (uint8_t*)&amp;pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    uint8_t* ptrSrcEnd = pbuf + pbufSize;</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    <a class="code" href="structpacket__ftr__t.html">packet_ftr_t</a> ftr;</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    uint32_t actualCheckSumValue;</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;    <span class="comment">// determine if checksum is 16 bit or 24 bit</span></div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;    uint8_t* bufPtr = pbuf + 1;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    uint32_t is24BitChecksum;</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;    if (*bufPtr++ == PSC_RESERVED_KEY) bufPtr++; <span class="comment">// skip id</span></div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="keywordflow">if</span> (*bufPtr++ == PSC_RESERVED_KEY) bufPtr++; <span class="comment">// skip counter</span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    <span class="keywordflow">if</span> (*bufPtr == PSC_RESERVED_KEY)</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;    {</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;        is24BitChecksum = ((~(*(++bufPtr))) &amp; CM_PKT_FLAGS_CHECKSUM_24_BIT);</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    }</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    {</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        is24BitChecksum = (*bufPtr &amp; CM_PKT_FLAGS_CHECKSUM_24_BIT);</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    }</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    <span class="keywordflow">if</span> (is24BitChecksum)</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;    {</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;        decodeBinaryPacketFooter24(&amp;ftr, ptrSrc, &amp;ptrSrcEnd, &amp;actualCheckSumValue);</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    }</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    {</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;        decodeBinaryPacketFooter16(&amp;ftr, &amp;ptrSrcEnd, &amp;actualCheckSumValue);</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    }</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    uint32_t shifter = (is24BitChecksum ? 0 : 8);</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    uint32_t checkSumValue = (is24BitChecksum ? CHECKSUM_SEED : 0x0000FF00);</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="comment">// start packet byte</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;    *ptrDest++ = *ptrSrc++;</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    </div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;    <span class="keywordflow">if</span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;    (</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;        <span class="comment">// packet id</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        decodeBinaryPacketByte(cmInstance, pHandle, &amp;ptrSrc, &amp;ptrDest, &amp;checkSumValue, 0) ||</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        <span class="comment">// packet counter</span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;        decodeBinaryPacketByte(cmInstance, pHandle, &amp;ptrSrc, &amp;ptrDest, &amp;checkSumValue, 8) ||</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        <span class="comment">// packet flags</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        decodeBinaryPacketByte(cmInstance, pHandle, &amp;ptrSrc, &amp;ptrDest, &amp;checkSumValue, (is24BitChecksum ? 16 : 0))</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    )</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    {</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    }</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    <span class="comment">// decode the body - start shift 8</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;    ptrDest = pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>;</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <span class="keywordflow">while</span> (ptrSrc &lt; ptrSrcEnd)</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    {</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        <span class="keywordflow">if</span> (decodeBinaryPacketByte(cmInstance, pHandle, &amp;ptrSrc, &amp;ptrDest, &amp;checkSumValue, shifter))</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;        {</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        }</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        <span class="keywordflow">if</span> (is24BitChecksum)</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;        {</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;            shifter += 8;</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;            <span class="comment">// reset if shifter equals 24</span></div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;            shifter *= (shifter != 24);</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        }</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;        {</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;            shifter ^= 8;</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        }</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;    }</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <span class="keywordflow">if</span> (actualCheckSumValue != checkSumValue)</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    {</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;        <span class="comment">// corrupt data</span></div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += 32;</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    }</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = (uint32_t)(ptrDest - pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>);</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> &gt; MAX_PKT_BODY_SIZE)</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;    {</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        <span class="comment">// corrupt data</span></div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">readCounter</a> += 32;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;    }</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;    <span class="comment">// if the endianness of the packet doesn&#39;t match our CPU, we need to flip the data so it will be correct for our CPU architecture</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> != 0 &amp;&amp; (pkt-&gt;<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> &amp; CM_PKT_FLAGS_ENDIANNESS_MASK) != CPU_IS_LITTLE_ENDIAN)</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;    {</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;        swapPacket(pkt);</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;    }</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;}</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="keywordtype">int</span> processAsciiPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> dataLength)</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;{</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;    <span class="keywordflow">if</span> (processAsciiRxPacket(cmInstance, pHandle, data, dataLength))</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;    {</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;        <span class="comment">// Error parsing packet</span></div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a277a4268d8d1eb8e152c65f016d64f68">rxError</a> = -1;</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8542bc5e9db157565ea3418ed158e070">communicationErrorCount</a>++;</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    }</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;}</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;<span class="keywordtype">int</span> processBinaryPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* dataStart, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> dataLength, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* additionalDataAvailable)</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;{</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    <a class="code" href="structpacket__t.html">packet_t</a> pkt;</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;    pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = dataStart;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    <span class="comment">// Found Packet -&gt; Now process packet</span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    <span class="keywordflow">if</span> (!decodeBinaryPacket(cmInstance, pHandle, &amp;pkt, data, dataLength))</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;    {</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        <span class="comment">// bit index 2 is whether another packet is available that is related to this packet</span></div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        *additionalDataAvailable = pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">flags</a> &amp; CM_PKT_FLAGS_MORE_DATA_AVAILABLE;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;        <span class="keywordflow">if</span> (!processBinaryRxPacket(cmInstance, pHandle, &amp;pkt, *additionalDataAvailable))</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;        {</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;        }</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    }</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <span class="comment">// Error parsing packet</span></div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a277a4268d8d1eb8e152c65f016d64f68">rxError</a> = -1;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a8542bc5e9db157565ea3418ed158e070">communicationErrorCount</a>++;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;}</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;<span class="keywordtype">int</span> processPassThroughBytes(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer)</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;{</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    (void)pHandle;</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    uint8_t startByte = cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a>;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    uint32_t passThroughIndex = ringBuffer-&gt;startIndex;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    uint32_t byteCount = _MIN(cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a>, ringBuffer-&gt;endIndex - ringBuffer-&gt;startIndex);</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a> -= byteCount;</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    ringBuffer-&gt;startIndex += byteCount;</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;    ringBuffer-&gt;scanIndex = ringBuffer-&gt;startIndex;</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;    <span class="comment">// clear the start byte once all pass through bytes are sent</span></div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;    <span class="keywordflow">if</span> (cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a> &lt;= 0)</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;    {</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    }</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;    <span class="keywordflow">switch</span> (startByte)</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;    {</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        <span class="keywordflow">case</span> UBLOX_START_BYTE1:</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;        <span class="keywordflow">case</span> RTCM3_START_BYTE:</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        {</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;            <span class="keywordflow">if</span> (cmInstance-&gt;passThroughHandler != 0)</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;            {</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                cmInstance-&gt;passThroughHandler(cmInstance, (com_manager_pass_through_t)startByte, pHandle, ringBuffer-&gt;buf + passThroughIndex, byteCount);</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;            }</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;        } <span class="keywordflow">break</span>;</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;    }</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;}</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="keywordtype">int</span> beginUbloxPacket(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer)</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;{</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;    uint32_t count = ringBuffer-&gt;endIndex - (--ringBuffer-&gt;scanIndex);</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;    <span class="keywordflow">if</span> (count &lt; UBLOX_HEADER_SIZE)</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;    {</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        <span class="comment">// not enough data to read a ublox packet header, wait for more data to arrive</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        <span class="keywordflow">return</span> 1; <span class="comment">// 1 means more data needed</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;    }</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;    <span class="comment">// get the header starting at the ublox start byte</span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* header = (ringBuffer-&gt;buf + ringBuffer-&gt;scanIndex);</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;    <span class="keywordtype">int</span> headerLength = ((int)header[4] | (<span class="keywordtype">int</span>)header[5] &lt;&lt; 8);</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;    <span class="comment">// if the second preamble byte is wrong or the length is greater than 2048, probably not a ublox packet</span></div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    <span class="keywordflow">if</span> (header[1] != UBLOX_START_BYTE2 || headerLength &gt; 2048)</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    {</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;        <span class="comment">// skip past the ublox start byte to avoid an infinite loop</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;        ringBuffer-&gt;scanIndex++;</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;        <span class="keywordflow">return</span> 0; <span class="comment">// 0 means keep reading as normal</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    }</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    <span class="comment">// probably a valid ublox packet</span></div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = UBLOX_START_BYTE1;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex;</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a> = UBLOX_HEADER_SIZE + headerLength + 2; <span class="comment">// + 2 for checksum</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <span class="keywordflow">return</span> 0; <span class="comment">// 0 means keep reading as normal</span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;}</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="keywordtype">int</span> beginRtcm3Packet(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, <a class="code" href="structring__buffer__t.html">ring_buffer_t</a>* ringBuffer)</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;{</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;    uint32_t count = ringBuffer-&gt;endIndex - (--ringBuffer-&gt;scanIndex);</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    <span class="keywordflow">if</span> (count &lt; RTCM3_HEADER_SIZE)</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    {</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;        <span class="comment">// not enough data to read a rtcm3 packet header, wait for more data to arrive</span></div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        <span class="keywordflow">return</span> 1; <span class="comment">// 1 means more data needed</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    }</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;    <span class="comment">// if message length valid, probably an rtcm3 packet, message length starts at bit 14 and goes for 10 bits</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    uint32_t msgLength = 0;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;    <span class="keywordflow">for</span> (uint32_t i = 14; i &lt; 14 + 10; i++)</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;    {</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;        msgLength = (msgLength &lt;&lt; 1) + ((ringBuffer-&gt;buf[ringBuffer-&gt;scanIndex + (i / 8)] &gt;&gt; (7 - i % 8)) &amp; 1u);</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    }</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    <span class="keywordflow">if</span> (msgLength &gt; 1023)</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    {</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        ringBuffer-&gt;scanIndex++;</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = 0;</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    }</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    <span class="comment">// probably a valid rtcm3 packet</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">startByte</a> = RTCM3_START_BYTE;</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    ringBuffer-&gt;startIndex = ringBuffer-&gt;scanIndex;</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    cmInstance-&gt;status[pHandle].<a class="code" href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">passThroughBytes</a> = RTCM3_HEADER_SIZE + msgLength + 3; <span class="comment">// + 3 for crc24</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    <span class="keywordflow">return</span> 0; <span class="comment">// 0 means keep reading as normal</span></div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;}</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;<span class="comment">//  Packet Retry</span></div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;<span class="keywordtype">void</span> stepPacketRetry(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance)</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;{</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;    int32_t i;</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;    <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a>* ePkt;</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;    {</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[i]);</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;        <span class="comment">// No more retries in list</span></div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter == -2)</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;        {</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;        }</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        <span class="comment">// Check that retry is enabled</span></div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter &gt;= 0)</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;        {</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;            <span class="comment">// Check if counter has expired</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;            <span class="keywordflow">if</span> (--(ePkt-&gt;counter) == 0)</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;            {</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;                <span class="comment">// Reset counter</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;                ePkt-&gt;counter = cmInstance-&gt;ensureRetryCount;</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;                <span class="comment">// Reset packet</span></div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;                sendPacket(cmInstance, ePkt-&gt;pHandle, &amp;(ePkt-&gt;pkt), 0);</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;            }</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        }</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;    }</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;}</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<a class="code" href="structpacket__t.html">packet_t</a>* registerPacketRetry(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <span class="keywordtype">int</span> pHandle, pkt_info_byte_t pid, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dataSize)</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;{</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;    int32_t i;</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a> *ePkt = 0;</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> searching = 1;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;<span class="preprocessor">#if ENABLE_FILTER_DUPLICATE_PACKETS</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;<span class="preprocessor">#if ENABLE_FILTER_DUPLICATE_PACKETS_MATCH_ALL_CHARACTERS</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    int32_t j;</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    <span class="comment">// Filter out redundant retries (replace same type packets and pHandle with latest)</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;    <a class="code" href="structp__data__get__t.html">p_data_get_t</a> *getData1, *getData2;</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;    <span class="comment">// Validate Data Size</span></div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;    <span class="keywordflow">if</span> (dataSize &gt; MAX_P_DATA_BODY_SIZE)</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;    {</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;    }</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    <span class="comment">// Check for existing retry</span></div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;    <span class="keywordflow">for</span> (i = 0; searching &amp;&amp; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;    {</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[i]);</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;        <span class="comment">// No more retries to search over.  Abort and look for first disabled slot.</span></div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter == -2)</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;        {</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;        }</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;        <span class="comment">// Found enabled retry w/ matching packet ID and data size</span></div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter &gt;= 0 &amp;&amp;</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;            ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> == pid        &amp;&amp;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;            ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> == dataSize &amp;&amp;</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;            ePkt-&gt;pHandle == pHandle)</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;        {</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;            <span class="keywordflow">switch</span> (pid)</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;            {</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;            <span class="keywordflow">case</span> PID_GET_DATA:</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;                getData1 = (<a class="code" href="structp__data__get__t.html">p_data_get_t</a>*)data;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;                getData2 = (<a class="code" href="structp__data__get__t.html">p_data_get_t</a>*)ePkt-&gt;pktBody;</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;                <span class="comment">// Match: all Get Data parameters</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;                if (getData1-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a> == getData2-&gt;<a class="code" href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">id</a>     &amp;&amp;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;                    getData1-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a> == getData2-&gt;<a class="code" href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">size</a>   &amp;&amp;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;                    getData1-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a> == getData2-&gt;<a class="code" href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">offset</a>)</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;                    searching = 0;</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;            <span class="keywordflow">case</span> PID_STOP_ALL_BROADCASTS:</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;                searching = 0;</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="preprocessor">#if !ENABLE_FILTER_DUPLICATE_PACKETS_MATCH_ALL_CHARACTERS</span></div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;                <span class="comment">// Match: first character</span></div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                <span class="keywordflow">if</span> (ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>[0] == data[0])</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;                {</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;                    searching = 0;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;                }</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;                <span class="comment">// Match: All character</span></div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;                <span class="keywordflow">for</span> (j = 0; j &lt; dataSize; j++)</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;                {</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;                    <span class="keywordflow">if</span> (ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>[j] == data[j])</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;                    {</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;                        searching = 0;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;                    }</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;                }</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;            }</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;        }</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;    }</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;    <span class="comment">// Find Empty Slot - either first available or tail if all used.</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;    <span class="keywordflow">for</span> (i = 0; searching &amp;&amp; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;    {</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[i]);</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;        <span class="comment">// Found empty slot</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter &lt; 0)</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;        {</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;            searching = 0;</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;        }</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    }</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    <span class="comment">// All slots enabled, so take the oldest (one after last used)</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    <span class="keywordflow">if</span> (searching &amp;&amp; cmInstance-&gt;ensuredPackets != 0)</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;    {</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;        <span class="keywordflow">if</span> (++cmInstance-&gt;lastEnsuredPacketIndex &gt;= cmInstance-&gt;maxEnsuredPackets)</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;        {</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;            cmInstance-&gt;lastEnsuredPacketIndex = 0;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;        }</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[cmInstance-&gt;lastEnsuredPacketIndex]);</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;    }</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;    {</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;        cmInstance-&gt;lastEnsuredPacketIndex = i;</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    }</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;    <span class="keywordflow">if</span> (ePkt == 0)</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;    {</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;    }</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;    <span class="comment">// Backup packet contents for retry if not already registered</span></div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;    ePkt-&gt;counter = cmInstance-&gt;ensureRetryCount;</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    memcpy(ePkt-&gt;pktBody, data, dataSize);</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;    <span class="comment">// Update ePkt pkt header and body info</span></div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;    ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#aae0969a547bd5ea711e2fe7e2d9a5f4e">startByte</a> = PSC_START_BYTE;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;    ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a> = pid;</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;    ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a> = ePkt-&gt;pktBody; <span class="comment">// point to ePkt buffer &quot;pktBody&quot;</span></div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;    ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">size</a> = dataSize;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    ePkt-&gt;pHandle = pHandle;</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    <span class="keywordflow">return</span> &amp;(ePkt-&gt;pkt);</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;}</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="keywordtype">void</span> updatePacketRetryData(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structpacket__t.html">packet_t</a> *pkt)</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;{</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;    int32_t i;</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;    <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a> *ePkt;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;    <span class="comment">// Search for retries that match packet received.  If found, removed it from the retry list.</span></div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;    {</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[i]);</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter == -2)</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;        {</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;            <span class="comment">// No more retries to search for</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        }</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter &lt; 0)</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;        {</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;            <span class="comment">// This retry is disabled.  Skip it.</span></div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        }</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;        <span class="comment">// Found packet response expected.  Remove from retry list.</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;pktBody[0] == pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>[0])</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        {</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;            <span class="comment">// Indicate disabled retry</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;            ePkt-&gt;counter = -1;</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;        }</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    }</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;    <span class="comment">// Update last retry indicator</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;    <span class="keywordflow">for</span> (i = cmInstance-&gt;maxEnsuredPackets - 1; i &gt;= 0; i--)</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;    {</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;        <span class="comment">// Current is enabled so stop</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;ensuredPackets[i].counter &gt;= 0)</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;        {</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;        }</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        <span class="comment">// Indicate no more retries in list</span></div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;        cmInstance-&gt;ensuredPackets[i].counter = -2;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;    }</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;}</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;<span class="keywordtype">void</span> updatePacketRetryAck(<a class="code" href="structcom__manager__t.html">com_manager_t</a>* cmInstance, <a class="code" href="structpacket__t.html">packet_t</a> *pkt)</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;{</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;    int32_t i;</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;    <a class="code" href="structensured__pkt__t.html">ensured_pkt_t</a> *ePkt;</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;    <a class="code" href="structp__ack__t.html">p_ack_t</a> *ack;</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;    pkt_info_byte_t ackInfo;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;    ack = (<a class="code" href="structp__ack__t.html">p_ack_t</a>*)(pkt-&gt;<a class="code" href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">body</a>.<a class="code" href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">ptr</a>);</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;    ackInfo = (pkt_info_byte_t)(ack-&gt;<a class="code" href="structp__ack__t.html#abf05e90920db88b6ca818740dde82dc6">hdr</a>.<a class="code" href="structp__ack__hdr__t.html#a9c409a6deaf6d6bb1c8e1d2b73b3bf34">pktInfo</a>);</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;    <span class="comment">// Search for retries that match packet received.  If found, removed it from the retry list.</span></div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; cmInstance-&gt;maxEnsuredPackets; i++)</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;    {</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        ePkt = &amp;(cmInstance-&gt;ensuredPackets[i]);</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter == -2)</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        {</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;            <span class="comment">// No more retries to search for</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        }</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;        <span class="keywordflow">if</span> (ePkt-&gt;counter == -1)</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        {</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;            <span class="comment">// This retry is disabled.  Skip it.</span></div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;        }</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;        <span class="comment">// Check packet info matches </span></div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;        <span class="keywordflow">if</span> (ack-&gt;<a class="code" href="structp__ack__t.html#abf05e90920db88b6ca818740dde82dc6">hdr</a>.<a class="code" href="structp__ack__hdr__t.html#a9c409a6deaf6d6bb1c8e1d2b73b3bf34">pktInfo</a> == ePkt-&gt;pkt.<a class="code" href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">hdr</a>.<a class="code" href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">pid</a>)</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;        {</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;            <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> *dHdr, *eHdr;</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;            <span class="keywordflow">switch</span> (ackInfo)</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;            {</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;            <span class="keywordflow">default</span>:</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;                <span class="comment">// Custom/Specific Packets</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;            <span class="keywordflow">case</span> PID_STOP_ALL_BROADCASTS: <span class="comment">// No body ID available</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;                ePkt-&gt;counter = -1;                 <span class="comment">// indicate disabled retry</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;            <span class="keywordflow">case</span> PID_SET_DATA:</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;                dHdr = (<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)ack-&gt;<a class="code" href="structp__ack__t.html#a2c304755ebea9c13682813a6edd44a1a">buf</a>;</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;                eHdr = (<a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a>*)(ePkt-&gt;pktBody);</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;                <span class="keywordflow">if</span> (dHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> == eHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">id</a> &amp;&amp;</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;                    dHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> == eHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> &amp;&amp;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;                    dHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a> == eHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>)</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;                {</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;                    ePkt-&gt;counter = -1;             <span class="comment">// indicate disabled retry</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;                }</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;            }</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;        }</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;    }</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;    <span class="comment">// Update last retry indicator</span></div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;    <span class="keywordflow">for</span> (i = cmInstance-&gt;maxEnsuredPackets - 1; i &gt;= 0; i--)</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;    {</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;        <span class="comment">// Current is enabled so stop</span></div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;        <span class="keywordflow">if</span> (cmInstance-&gt;ensuredPackets[i].counter &gt;= 0)</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;        {</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;        }</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;        cmInstance-&gt;ensuredPackets[i].counter = -2;         <span class="comment">// Indicate no more retries in list</span></div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;    }</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;}</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;<span class="keywordtype">char</span> copyDataPToStructP(<span class="keywordtype">void</span> *sptr, <span class="keyword">const</span> <a class="code" href="structp__data__t.html">p_data_t</a> *data, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsize)</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;{</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;    <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> + data-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>) &lt;= maxsize)</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;    {</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        memcpy((uint8_t*)sptr + data-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>, data-&gt;<a class="code" href="structp__data__t.html#a006c80696cc8ad6e3699d853da9c9c07">buf</a>, data-&gt;<a class="code" href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">hdr</a>.<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>);</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;    }</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;    {</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;    }</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;}</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;<span class="keywordtype">char</span> copyDataPToStructP2(<span class="keywordtype">void</span> *sptr, <span class="keyword">const</span> <a class="code" href="structp__data__hdr__t.html">p_data_hdr_t</a> *dataHdr, <span class="keyword">const</span> uint8_t *dataBuf, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsize)</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;{</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    <span class="keywordflow">if</span> ((dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a> + dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>) &lt;= maxsize)</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    {</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        memcpy((uint8_t*)sptr + dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">offset</a>, dataBuf, dataHdr-&gt;<a class="code" href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">size</a>);</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;    }</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;    {</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;    }</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;}</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="keywordtype">int</span> validateBaudRate(<span class="keywordtype">int</span> baudRate)</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;{</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;    <span class="comment">// Valid baudrates for InertialSense hardware</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;    <span class="keywordflow">switch</span> (baudRate)</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;    {</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;        <span class="keywordflow">case</span> IS_BAUDRATE_115200:</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;        <span class="keywordflow">case</span> IS_BAUDRATE_230400:</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;        <span class="keywordflow">case</span> IS_BAUDRATE_460800:</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;        <span class="keywordflow">case</span> IS_BAUDRATE_921600:</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;        <span class="keywordflow">case</span> IS_BAUDRATE_3000000:</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;            <span class="keywordflow">return</span> 0;   <span class="comment">// success</span></div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    }</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    <span class="keywordflow">return</span> -1;  <span class="comment">// failure</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;}</div><div class="ttc" id="structcom__manager__status__t_html_a9b358bcb95013a3606a763c35a66538d"><div class="ttname"><a href="structcom__manager__status__t.html#a9b358bcb95013a3606a763c35a66538d">com_manager_status_t::rxPktCount</a></div><div class="ttdeci">uint32_t rxPktCount</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00410">com_manager.h:410</a></div></div>
<div class="ttc" id="structpacket__t_html_a4955d2c7f0cacef9987e6e33a7dfc885"><div class="ttname"><a href="structpacket__t.html#a4955d2c7f0cacef9987e6e33a7dfc885">packet_t::body</a></div><div class="ttdeci">bufPtr_t body</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00277">com_manager.h:277</a></div></div>
<div class="ttc" id="structpacket__hdr__t_html_aae0969a547bd5ea711e2fe7e2d9a5f4e"><div class="ttname"><a href="structpacket__hdr__t.html#aae0969a547bd5ea711e2fe7e2d9a5f4e">packet_hdr_t::startByte</a></div><div class="ttdeci">uint8_t startByte</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00236">com_manager.h:236</a></div></div>
<div class="ttc" id="structbuf_tx_rx_ptr__t_html_aa35ef37b9fa29843a3f96140484c3dce"><div class="ttname"><a href="structbuf_tx_rx_ptr__t.html#aa35ef37b9fa29843a3f96140484c3dce">bufTxRxPtr_t::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00178">com_manager.h:178</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_ae21797145c303bff1e0df2126550232d"><div class="ttname"><a href="structcom__manager__status__t.html#ae21797145c303bff1e0df2126550232d">com_manager_status_t::passThroughBytes</a></div><div class="ttdeci">uint32_t passThroughBytes</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00428">com_manager.h:428</a></div></div>
<div class="ttc" id="structbuf_tx_rx_ptr__t_html_a3c8e53783acdd89e12c360315fbaac0e"><div class="ttname"><a href="structbuf_tx_rx_ptr__t.html#a3c8e53783acdd89e12c360315fbaac0e">bufTxRxPtr_t::rxPtr</a></div><div class="ttdeci">uint8_t * rxPtr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00175">com_manager.h:175</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_a8212909888b506491643d391cd7da2c3"><div class="ttname"><a href="structcom__manager__status__t.html#a8212909888b506491643d391cd7da2c3">com_manager_status_t::flags</a></div><div class="ttdeci">uint8_t flags</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00422">com_manager.h:422</a></div></div>
<div class="ttc" id="structbuf_ptr__t_html"><div class="ttname"><a href="structbuf_ptr__t.html">bufPtr_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00159">com_manager.h:159</a></div></div>
<div class="ttc" id="structp__data__hdr__t_html_a0a70811dba0872fe68a2d58c24cb7894"><div class="ttname"><a href="structp__data__hdr__t.html#a0a70811dba0872fe68a2d58c24cb7894">p_data_hdr_t::id</a></div><div class="ttdeci">uint32_t id</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00292">com_manager.h:292</a></div></div>
<div class="ttc" id="structp__data__hdr__t_html_ae4e77713f907776d843284114634d642"><div class="ttname"><a href="structp__data__hdr__t.html#ae4e77713f907776d843284114634d642">p_data_hdr_t::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00295">com_manager.h:295</a></div></div>
<div class="ttc" id="structbuffer__t_html_ac75c7fd252491f31cc9fa3458aafad8d"><div class="ttname"><a href="structbuffer__t.html#ac75c7fd252491f31cc9fa3458aafad8d">buffer_t::buf</a></div><div class="ttdeci">uint8_t buf[PKT_BUF_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00155">com_manager.h:155</a></div></div>
<div class="ttc" id="structensured__pkt__t_html"><div class="ttname"><a href="structensured__pkt__t.html">ensured_pkt_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8c_source.html#l00081">com_manager.c:81</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_a8542bc5e9db157565ea3418ed158e070"><div class="ttname"><a href="structcom__manager__status__t.html#a8542bc5e9db157565ea3418ed158e070">com_manager_status_t::communicationErrorCount</a></div><div class="ttdeci">uint32_t communicationErrorCount</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00416">com_manager.h:416</a></div></div>
<div class="ttc" id="structpacket__ftr__t_html_a6e42e66db3c3d40746082e91c379069d"><div class="ttname"><a href="structpacket__ftr__t.html#a6e42e66db3c3d40746082e91c379069d">packet_ftr_t::cksum1</a></div><div class="ttdeci">uint8_t cksum1</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00264">com_manager.h:264</a></div></div>
<div class="ttc" id="structascii_message_map__t_html_a9f826f57213df4538aa34db3d4513ab3"><div class="ttname"><a href="structascii_message_map__t.html#a9f826f57213df4538aa34db3d4513ab3">asciiMessageMap_t::fieldCount</a></div><div class="ttdeci">int fieldCount</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00226">com_manager.h:226</a></div></div>
<div class="ttc" id="structpacket__t_html_ac12697f39d3daa260b81fc186a32acf8"><div class="ttname"><a href="structpacket__t.html#ac12697f39d3daa260b81fc186a32acf8">packet_t::hdr</a></div><div class="ttdeci">packet_hdr_t hdr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00274">com_manager.h:274</a></div></div>
<div class="ttc" id="structbuf_tx_rx_ptr__t_html"><div class="ttname"><a href="structbuf_tx_rx_ptr__t.html">bufTxRxPtr_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00169">com_manager.h:169</a></div></div>
<div class="ttc" id="structascii_message_map__t_html_a321bf44d43b7484a7b206741225a0a1a"><div class="ttname"><a href="structascii_message_map__t.html#a321bf44d43b7484a7b206741225a0a1a">asciiMessageMap_t::messageId</a></div><div class="ttdeci">unsigned char messageId[4]</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00217">com_manager.h:217</a></div></div>
<div class="ttc" id="structascii_message_map__t_html_aff37daca4dfc68b724b2837748dc4cd9"><div class="ttname"><a href="structascii_message_map__t.html#aff37daca4dfc68b724b2837748dc4cd9">asciiMessageMap_t::fieldsAndOffsets</a></div><div class="ttdeci">uint16_t * fieldsAndOffsets</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00229">com_manager.h:229</a></div></div>
<div class="ttc" id="structregistered__data__t_html"><div class="ttname"><a href="structregistered__data__t.html">registered_data_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8c_source.html#l00037">com_manager.c:37</a></div></div>
<div class="ttc" id="structp__ack__hdr__t_html_a9c409a6deaf6d6bb1c8e1d2b73b3bf34"><div class="ttname"><a href="structp__ack__hdr__t.html#a9c409a6deaf6d6bb1c8e1d2b73b3bf34">p_ack_hdr_t::pktInfo</a></div><div class="ttdeci">uint32_t pktInfo</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00341">com_manager.h:341</a></div></div>
<div class="ttc" id="structpacket__ftr__t_html_a7065d9b4532287ac5d3f18c9f7bef735"><div class="ttname"><a href="structpacket__ftr__t.html#a7065d9b4532287ac5d3f18c9f7bef735">packet_ftr_t::stopByte</a></div><div class="ttdeci">uint8_t stopByte</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00267">com_manager.h:267</a></div></div>
<div class="ttc" id="structbroadcast__msg__t_html"><div class="ttname"><a href="structbroadcast__msg__t.html">broadcast_msg_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8c_source.html#l00053">com_manager.c:53</a></div></div>
<div class="ttc" id="structbuffer__t_html"><div class="ttname"><a href="structbuffer__t.html">buffer_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00149">com_manager.h:149</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html"><div class="ttname"><a href="structcom__manager__status__t.html">com_manager_status_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00401">com_manager.h:401</a></div></div>
<div class="ttc" id="structp__data__get__t_html_a0123a3db2bf728e0d199bcb606123ec8"><div class="ttname"><a href="structp__data__get__t.html#a0123a3db2bf728e0d199bcb606123ec8">p_data_get_t::offset</a></div><div class="ttdeci">uint32_t offset</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00321">com_manager.h:321</a></div></div>
<div class="ttc" id="structp__ack__hdr__t_html_a6e047dce01db1c893021485be63cbb6f"><div class="ttname"><a href="structp__ack__hdr__t.html#a6e047dce01db1c893021485be63cbb6f">p_ack_hdr_t::pktCounter</a></div><div class="ttdeci">uint32_t pktCounter</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00344">com_manager.h:344</a></div></div>
<div class="ttc" id="structp__ack__t_html_abf05e90920db88b6ca818740dde82dc6"><div class="ttname"><a href="structp__ack__t.html#abf05e90920db88b6ca818740dde82dc6">p_ack_t::hdr</a></div><div class="ttdeci">p_ack_hdr_t hdr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00351">com_manager.h:351</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_a0ad6d483eb2fbd825a90a518dad9e0ce"><div class="ttname"><a href="structcom__manager__status__t.html#a0ad6d483eb2fbd825a90a518dad9e0ce">com_manager_status_t::txPktCount</a></div><div class="ttdeci">uint32_t txPktCount</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00413">com_manager.h:413</a></div></div>
<div class="ttc" id="structcom__manager__t_html"><div class="ttname"><a href="structcom__manager__t.html">com_manager_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8c_source.html#l00111">com_manager.c:111</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_a277a4268d8d1eb8e152c65f016d64f68"><div class="ttname"><a href="structcom__manager__status__t.html#a277a4268d8d1eb8e152c65f016d64f68">com_manager_status_t::rxError</a></div><div class="ttdeci">uint32_t rxError</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00407">com_manager.h:407</a></div></div>
<div class="ttc" id="structpacket__ftr__t_html_ac354b0937e265b7e75d9a68378a8c651"><div class="ttname"><a href="structpacket__ftr__t.html#ac354b0937e265b7e75d9a68378a8c651">packet_ftr_t::cksum2</a></div><div class="ttdeci">uint8_t cksum2</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00261">com_manager.h:261</a></div></div>
<div class="ttc" id="structp__data__disable__t_html_aca2ef5d5ec699f32fe117e470f6c1986"><div class="ttname"><a href="structp__data__disable__t.html#aca2ef5d5ec699f32fe117e470f6c1986">p_data_disable_t::id</a></div><div class="ttdeci">uint32_t id</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00334">com_manager.h:334</a></div></div>
<div class="ttc" id="structpkt__info__t_html"><div class="ttname"><a href="structpkt__info__t.html">pkt_info_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00281">com_manager.h:281</a></div></div>
<div class="ttc" id="structbuf_ptr__t_html_ad4295aa9699eea57f6219a92475a327c"><div class="ttname"><a href="structbuf_ptr__t.html#ad4295aa9699eea57f6219a92475a327c">bufPtr_t::ptr</a></div><div class="ttdeci">uint8_t * ptr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00162">com_manager.h:162</a></div></div>
<div class="ttc" id="structp__ack__t_html"><div class="ttname"><a href="structp__ack__t.html">p_ack_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00348">com_manager.h:348</a></div></div>
<div class="ttc" id="structp__data__t_html_ad581435f6761781c248158d69ca502f9"><div class="ttname"><a href="structp__data__t.html#ad581435f6761781c248158d69ca502f9">p_data_t::hdr</a></div><div class="ttdeci">p_data_hdr_t hdr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00305">com_manager.h:305</a></div></div>
<div class="ttc" id="structp__data__get__t_html_ab12d63b4fd0d9d6f5a27e8b0856af7a8"><div class="ttname"><a href="structp__data__get__t.html#ab12d63b4fd0d9d6f5a27e8b0856af7a8">p_data_get_t::id</a></div><div class="ttdeci">uint32_t id</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00315">com_manager.h:315</a></div></div>
<div class="ttc" id="structpacket__hdr__t_html_a915f088eeed50b151584165a97598709"><div class="ttname"><a href="structpacket__hdr__t.html#a915f088eeed50b151584165a97598709">packet_hdr_t::pid</a></div><div class="ttdeci">uint8_t pid</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00239">com_manager.h:239</a></div></div>
<div class="ttc" id="structascii_message_map__t_html_a33d8b7845ee9c8d532fa5e22fadb9b37"><div class="ttname"><a href="structascii_message_map__t.html#a33d8b7845ee9c8d532fa5e22fadb9b37">asciiMessageMap_t::ptr</a></div><div class="ttdeci">uint8_t * ptr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00220">com_manager.h:220</a></div></div>
<div class="ttc" id="structbuffer__t_html_ab1ce0deb7a33566b5c9e2705ae822007"><div class="ttname"><a href="structbuffer__t.html#ab1ce0deb7a33566b5c9e2705ae822007">buffer_t::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00152">com_manager.h:152</a></div></div>
<div class="ttc" id="structp__data__hdr__t_html"><div class="ttname"><a href="structp__data__hdr__t.html">p_data_hdr_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00289">com_manager.h:289</a></div></div>
<div class="ttc" id="structbuf_tx_rx_ptr__t_html_adb7fdcf7f9e8c13377db7643b67199b2"><div class="ttname"><a href="structbuf_tx_rx_ptr__t.html#adb7fdcf7f9e8c13377db7643b67199b2">bufTxRxPtr_t::txPtr</a></div><div class="ttdeci">uint8_t * txPtr</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00172">com_manager.h:172</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_a799659757d78ea8a857bc35994b9cb8a"><div class="ttname"><a href="structcom__manager__status__t.html#a799659757d78ea8a857bc35994b9cb8a">com_manager_status_t::startByte</a></div><div class="ttdeci">uint8_t startByte</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00425">com_manager.h:425</a></div></div>
<div class="ttc" id="structp__ack__hdr__t_html"><div class="ttname"><a href="structp__ack__hdr__t.html">p_ack_hdr_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00338">com_manager.h:338</a></div></div>
<div class="ttc" id="structp__data__t_html"><div class="ttname"><a href="structp__data__t.html">p_data_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00302">com_manager.h:302</a></div></div>
<div class="ttc" id="structpacket__ftr__t_html_a09927e370e8faf154f669a88c42be952"><div class="ttname"><a href="structpacket__ftr__t.html#a09927e370e8faf154f669a88c42be952">packet_ftr_t::cksum3</a></div><div class="ttdeci">uint8_t cksum3</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00258">com_manager.h:258</a></div></div>
<div class="ttc" id="structring__buffer__t_html"><div class="ttname"><a href="structring__buffer__t.html">ring_buffer_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8c_source.html#l00103">com_manager.c:103</a></div></div>
<div class="ttc" id="structpacket__t_html"><div class="ttname"><a href="structpacket__t.html">packet_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00271">com_manager.h:271</a></div></div>
<div class="ttc" id="structbuf_ptr__t_html_a89121516bb8e4f198c13eaf8e1d23457"><div class="ttname"><a href="structbuf_ptr__t.html#a89121516bb8e4f198c13eaf8e1d23457">bufPtr_t::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00165">com_manager.h:165</a></div></div>
<div class="ttc" id="structp__data__get__t_html_ae844be67615d36ebcbd704e75f13613e"><div class="ttname"><a href="structp__data__get__t.html#ae844be67615d36ebcbd704e75f13613e">p_data_get_t::bc_period_ms</a></div><div class="ttdeci">uint32_t bc_period_ms</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00327">com_manager.h:327</a></div></div>
<div class="ttc" id="structp__data__t_html_a006c80696cc8ad6e3699d853da9c9c07"><div class="ttname"><a href="structp__data__t.html#a006c80696cc8ad6e3699d853da9c9c07">p_data_t::buf</a></div><div class="ttdeci">uint8_t buf[MAX_DATASET_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00308">com_manager.h:308</a></div></div>
<div class="ttc" id="structcom__manager__status__t_html_ac612f97d0b588330e0ce0293170a60f0"><div class="ttname"><a href="structcom__manager__status__t.html#ac612f97d0b588330e0ce0293170a60f0">com_manager_status_t::readCounter</a></div><div class="ttdeci">uint32_t readCounter</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00404">com_manager.h:404</a></div></div>
<div class="ttc" id="structpacket__hdr__t_html_a2f70c5610514823dd705571fd68df9d7"><div class="ttname"><a href="structpacket__hdr__t.html#a2f70c5610514823dd705571fd68df9d7">packet_hdr_t::flags</a></div><div class="ttdeci">uint8_t flags</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00251">com_manager.h:251</a></div></div>
<div class="ttc" id="structp__data__hdr__t_html_a5671779d9843a522942f60cbca2dee18"><div class="ttname"><a href="structp__data__hdr__t.html#a5671779d9843a522942f60cbca2dee18">p_data_hdr_t::offset</a></div><div class="ttdeci">uint32_t offset</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00298">com_manager.h:298</a></div></div>
<div class="ttc" id="structpacket__ftr__t_html"><div class="ttname"><a href="structpacket__ftr__t.html">packet_ftr_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00255">com_manager.h:255</a></div></div>
<div class="ttc" id="structp__data__disable__t_html"><div class="ttname"><a href="structp__data__disable__t.html">p_data_disable_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00331">com_manager.h:331</a></div></div>
<div class="ttc" id="structpacket__hdr__t_html_a5e22ca5884ff79547cdaf5577cad9f41"><div class="ttname"><a href="structpacket__hdr__t.html#a5e22ca5884ff79547cdaf5577cad9f41">packet_hdr_t::counter</a></div><div class="ttdeci">uint8_t counter</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00242">com_manager.h:242</a></div></div>
<div class="ttc" id="structp__data__get__t_html_a11afc3ecb51275d65121ed378d24267a"><div class="ttname"><a href="structp__data__get__t.html#a11afc3ecb51275d65121ed378d24267a">p_data_get_t::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00318">com_manager.h:318</a></div></div>
<div class="ttc" id="structascii_message_map__t_html"><div class="ttname"><a href="structascii_message_map__t.html">asciiMessageMap_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00214">com_manager.h:214</a></div></div>
<div class="ttc" id="structp__data__get__t_html"><div class="ttname"><a href="structp__data__get__t.html">p_data_get_t</a></div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00312">com_manager.h:312</a></div></div>
<div class="ttc" id="structp__ack__t_html_a2c304755ebea9c13682813a6edd44a1a"><div class="ttname"><a href="structp__ack__t.html#a2c304755ebea9c13682813a6edd44a1a">p_ack_t::buf</a></div><div class="ttdeci">uint8_t buf[MAX_P_ACK_BODY_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="com__manager_8h_source.html#l00354">com_manager.h:354</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 16 2017 23:00:11 for SDK by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
